<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>গ্রোসারি পস সিস্টেম - মোবাইল অপ্টিমাইজড</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts for Bengali -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Hind Siliguri', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* Input Number Arrows Remove */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }

        /* ==========================================
           IMPROVED PRINT STYLES (THERMAL PRINTER READY)
           ========================================== */
        @media print {
            @page {
                size: 80mm auto; /* Standard Thermal Printer Width */
                margin: 0;
            }
            body { 
                background: white; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
            }
            
            /* Hide UI Elements */
            body > * { display: none !important; }
            .no-print { display: none !important; }

            /* Show Memo Only */
            body.printing-memo #memo-modal {
                display: block !important;
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: white !important; z-index: 9999; overflow: visible;
            }
            body.printing-memo #memo-modal > div {
                box-shadow: none !important; border: none !important; width: 100% !important;
                max-width: 100% !important; height: auto !important; border-radius: 0 !important;
                margin: 0 !important; display: block !important;
            }
            body.printing-memo #memo-modal > div > div:first-child { display: none !important; } /* Hide Modal Header */
            body.printing-memo #memo-print-area {
                display: block !important; position: relative; width: 100%;
                color: black !important; background: white !important; border: none !important;
                padding: 10px !important; overflow: visible !important; font-size: 12px;
            }

            /* Show Report Only */
            body.printing-report #report-print-container {
                display: block !important; position: absolute; top: 0; left: 0; width: 100%;
                background: white !important; color: black !important; z-index: 9999;
                padding: 10px !important; margin: 0 !important; height: auto !important;
                overflow: visible !important; border: none !important; box-shadow: none !important;
                font-size: 12px;
            }

            /* Force Text Colors */
            body.printing-report #report-print-container *, 
            body.printing-memo #memo-print-area * {
                color: #000 !important; border-color: #000 !important;
                text-shadow: none !important; box-shadow: none !important;
            }
        }

        /* Smooth Transitions */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Bottom Sheet Shadow */
        .bottom-sheet-shadow {
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
        }
    </style>
    
    <script>
        // ==========================================
        // CONFIGURATION & STATE INIT
        // ==========================================
        const CONFIG = {
            DEFAULT_PIN: "1234",
            MASTER_RESET_CODE: "0000"
        };

        const initialState = {
            products: [
                { id: 1, name: 'মিনিকেট চাল (১ কেজি)', buyPrice: 90, sellPrice: 100, stock: 50, location: 'তাক ১' },
                { id: 2, name: 'সয়াবিন তেল (১ লিটার)', buyPrice: 160, sellPrice: 180, stock: 30, location: 'তাক ২' },
                { id: 3, name: 'দেশি পেঁয়াজ (১ কেজি)', buyPrice: 70, sellPrice: 85, stock: 100, location: 'তাক ১' },
                { id: 4, name: 'আলু (১ কেজি)', buyPrice: 30, sellPrice: 40, stock: 200, location: 'তাক ৩' }
            ],
            cart: [],
            salesHistory: [], 
            settings: {
                shopName: "আপনার দোকান",
                proprietor: "প্রোপাইটর নাম",
                mobile: "01700000000",
                pin: CONFIG.DEFAULT_PIN
            },
            isAdminUnlocked: false
        };

        let state = JSON.parse(JSON.stringify(initialState));

        function saveData() {
            localStorage.setItem('pos_bangla_data', JSON.stringify({
                products: state.products,
                salesHistory: state.salesHistory,
                settings: state.settings
            }));
        }

        function loadData() {
            const data = localStorage.getItem('pos_bangla_data');
            if (data) {
                const parsed = JSON.parse(data);
                state.products = parsed.products || [];
                state.salesHistory = parsed.salesHistory || [];
                state.settings = { ...state.settings, ...parsed.settings };
            }
        }
    </script>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden">

    <div id="app" class="flex flex-col h-full w-full relative">
        
        <!-- HEADER (Compact on Mobile) -->
        <header class="bg-emerald-700 text-white shadow-md z-20 shrink-0 cursor-pointer select-none no-print" onclick="goHome()">
            <div class="max-w-7xl mx-auto px-3 h-14 md:h-16 flex items-center justify-between">
                <div class="flex items-center gap-2 md:gap-3">
                    <i class="fa-solid fa-shop text-xl md:text-2xl text-emerald-300"></i>
                    <div>
                        <h1 id="shop-name-header" class="font-bold text-lg md:text-xl leading-tight truncate max-w-[150px] md:max-w-none">আপনার দোকান</h1>
                        <p id="shop-prop-header" class="text-[10px] md:text-xs text-emerald-200 hidden sm:block">প্রোপাইটর: নাম লিখুন</p>
                    </div>
                </div>
                <button onclick="event.stopPropagation(); toggleAdminAuth()" class="p-2 rounded-full hover:bg-emerald-800 transition-colors active:scale-95" title="সেটিংস">
                    <i class="fa-solid fa-gear text-lg md:text-xl"></i>
                </button>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main id="main-content" class="flex-1 flex overflow-hidden relative no-print">
            
            <!-- WORKER MODE -->
            <div id="worker-view" class="flex flex-col md:flex-row w-full h-full">
                
                <!-- Product Grid Section -->
                <div class="flex-1 flex flex-col h-full bg-slate-50 overflow-hidden relative">
                    <!-- Search Bar -->
                    <div class="p-3 bg-white shadow-sm z-10 shrink-0">
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><i class="fa-solid fa-magnifying-glass"></i></span>
                            <input type="text" id="product-search" placeholder="পণ্য খুঁজুন..." 
                                class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm md:text-base text-slate-700 shadow-sm">
                        </div>
                    </div>

                    <!-- Grid: 2 cols on mobile, 4 on PC -->
                    <div id="product-grid" class="flex-1 overflow-y-auto p-2 md:p-3 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-3 content-start pb-32 md:pb-10"></div>
                </div>

                <!-- Cart Panel (Bottom Sheet on Mobile, Sidebar on Desktop) -->
                <div id="cart-panel" class="w-full md:w-96 bg-white border-l border-slate-200 flex flex-col shadow-2xl z-30 fixed md:relative bottom-0 h-[45vh] md:h-full transform translate-y-full md:translate-y-0 transition-transform duration-300 ease-out rounded-t-2xl md:rounded-none bottom-sheet-shadow">
                    
                    <!-- Mobile Handle (Visible only on mobile) -->
                    <div class="md:hidden w-full flex justify-center pt-2 pb-1 cursor-pointer" onclick="toggleMobileCart()">
                        <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
                    </div>

                    <!-- Cart Header -->
                    <div class="px-3 py-2 md:p-4 border-b border-slate-100 flex justify-between items-center bg-emerald-50 md:bg-white">
                        <div class="flex items-center gap-2 cursor-pointer md:cursor-default" onclick="toggleMobileCart()">
                            <h2 class="font-bold text-base md:text-lg text-emerald-800"><i class="fa-solid fa-list-ul mr-1 md:mr-2"></i>বিক্রি তালিকা</h2>
                            <i class="fa-solid fa-chevron-up md:hidden text-emerald-600" id="mobile-cart-icon"></i>
                        </div>
                        <button onclick="clearCart(event)" class="text-xs md:text-sm text-red-500 hover:text-red-700 font-medium px-2 py-1 rounded hover:bg-red-50 transition">মুছুন</button>
                    </div>

                    <!-- Cart Items (Scrollable) -->
                    <div id="cart-items" class="flex-1 overflow-y-auto p-2 md:p-3 space-y-2"></div>

                    <!-- Cart Footer (Totals & Checkout) -->
                    <div class="p-3 bg-white border-t border-slate-200 space-y-2 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] shrink-0">
                        <div class="flex justify-between items-center text-xs md:text-sm font-medium text-slate-600">
                            <span>মোট পণ্য:</span>
                            <span id="cart-count-badge" class="bg-slate-100 px-2 py-0.5 rounded-full">0 টি</span>
                        </div>
                        <div class="flex justify-between items-center text-xl md:text-2xl font-bold text-slate-800">
                            <span>মোট</span>
                            <span id="cart-total" class="text-emerald-600">৳ ০</span>
                        </div>
                        <button onclick="handleCheckout()" id="checkout-btn" disabled class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 md:py-4 rounded-xl shadow-lg shadow-emerald-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-95 text-base md:text-lg mt-2">
                            চালান তৈরি করুন
                        </button>
                    </div>
                </div>
            </div>

            <!-- ADMIN MODE -->
            <div id="admin-view" class="hidden w-full h-full bg-slate-100 flex flex-col md:flex-row overflow-hidden">
                <!-- Sidebar -->
                <div class="w-full md:w-64 bg-slate-900 text-slate-300 flex flex-col shrink-0 no-print">
                    <div class="p-4 border-b border-slate-700"><p class="text-xs uppercase tracking-wider font-semibold text-slate-500">অ্যাডমিন প্যানেল</p><h3 class="text-white font-bold mt-1">ম্যানেজমেন্ট</h3></div>
                    <nav class="flex-1 overflow-y-auto py-4 space-y-1">
                        <button onclick="switchAdminTab('inventory')" class="admin-tab w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white transition-colors border-l-4 border-transparent active-tab"><i class="fa-solid fa-boxes-stacked w-6"></i> পণ্য তালিকা</button>
                        <button onclick="switchAdminTab('reports')" class="admin-tab w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white transition-colors border-l-4 border-transparent"><i class="fa-solid fa-chart-line w-6"></i> বিক্রয় রিপোর্ট</button>
                        <button onclick="switchAdminTab('settings')" class="admin-tab w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white transition-colors border-l-4 border-transparent"><i class="fa-solid fa-sliders w-6"></i> দোকানের সেটিংস</button>
                    </nav>
                    <div class="p-4 border-t border-slate-700">
                        <button onclick="exitAdminMode()" class="w-full flex items-center px-2 py-2 text-sm bg-red-900/50 text-red-200 hover:bg-red-600 hover:text-white rounded transition">
                            <i class="fa-solid fa-right-from-bracket mr-2"></i> লগআউট
                        </button>
                    </div>
                </div>

                <!-- Admin Content -->
                <div class="flex-1 overflow-y-auto p-3 md:p-8">
                    
                    <!-- Tab: Inventory -->
                    <div id="tab-inventory" class="admin-content space-y-4">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                            <h2 class="text-xl md:text-2xl font-bold text-slate-800">পণ্য ইনভেনটরি</h2>
                            <button onclick="openProductModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition text-sm"><i class="fa-solid fa-plus mr-2"></i> নতুন পণ্য</button>
                        </div>
                        
                        <!-- Table Container for Mobile Scroll -->
                        <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm text-slate-600 min-w-[600px]"> <!-- min-w forces scroll on mobile -->
                                    <thead class="bg-slate-50 text-slate-700 uppercase font-semibold">
                                        <tr>
                                            <th class="px-4 py-3">পণ্যের নাম</th>
                                            <th class="px-4 py-3">কেনা দাম</th>
                                            <th class="px-4 py-3">বিক্রয় দাম</th>
                                            <th class="px-4 py-3">স্টক</th>
                                            <th class="px-4 py-3">অবস্থান</th>
                                            <th class="px-4 py-3 text-right">অ্যাকশন</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventory-table-body" class="divide-y divide-slate-100"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Reports -->
                    <div id="tab-reports" class="admin-content hidden space-y-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 no-print">
                            <h2 class="text-xl md:text-2xl font-bold text-slate-800">বিক্রয় রিপোর্ট</h2>
                            <button onclick="printSalesReport()" class="bg-slate-800 text-white px-4 py-2 rounded-lg shadow hover:bg-slate-900 transition flex items-center gap-2">
                                <i class="fa-solid fa-print"></i> রিপোর্ট প্রিন্ট
                            </button>
                        </div>
                        
                        <!-- Filters -->
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200 space-y-4 no-print">
                            <h3 class="font-bold text-lg text-slate-700 border-b pb-2">ফিল্টার করুন</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">নির্দিষ্ট তারিখ</label>
                                    <input type="date" id="report-date" oninput="generateReport('date')" onchange="generateReport('date')" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">নির্দিষ্ট মাস</label>
                                    <input type="month" id="report-month" oninput="generateReport('month')" onchange="generateReport('month')" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mt-2 gap-2">
                                <button onclick="clearReportFilters()" class="text-blue-600 text-sm hover:underline">ফিল্টার মুছে ফেলুন</button>
                                <button onclick="deleteHistoryBasedOnFilter()" class="text-red-600 text-sm font-medium hover:text-red-800 hover:underline flex items-center gap-1">
                                    <i class="fa-solid fa-trash-can"></i> ইতিহাস মুছে ফেলুন
                                </button>
                            </div>
                        </div>

                        <!-- Summary Cards -->
                        <div id="report-summary-cards" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="bg-blue-50 p-4 md:p-6 rounded-xl border border-blue-100"><p class="text-sm text-blue-600 mb-1">মোট বিক্রয়</p><p id="report-total-sales" class="text-xl md:text-2xl font-bold text-blue-800">৳ ০</p></div>
                            <div class="bg-orange-50 p-4 md:p-6 rounded-xl border border-orange-100"><p class="text-sm text-orange-600 mb-1">মোট খরচ</p><p id="report-total-cost" class="text-xl md:text-2xl font-bold text-orange-800">৳ ০</p></div>
                            <div class="bg-emerald-50 p-4 md:p-6 rounded-xl border border-emerald-100"><p class="text-sm text-emerald-600 mb-1">মোট লাভ</p><p id="report-profit" class="text-xl md:text-2xl font-bold text-emerald-800">৳ ০</p></div>
                        </div>

                        <!-- Detailed Sales Table -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="p-4 border-b border-slate-200 bg-slate-50 font-bold text-slate-700">বিক্রয়ের বিস্তারিত তালিকা</div>
                            <div class="overflow-x-auto max-h-80">
                                <table class="w-full text-left text-sm text-slate-600 min-w-[500px]">
                                    <thead class="bg-slate-100 text-slate-700 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-2">পণ্যের নাম</th>
                                            <th class="px-4 py-2 text-center">পরিমাণ</th>
                                            <th class="px-4 py-2 text-right">বিক্রয় মূল্য</th>
                                            <th class="px-4 py-2 text-right">সময়</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detailed-sales-body" class="divide-y divide-slate-100"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Settings -->
                    <div id="tab-settings" class="admin-content hidden space-y-6">
                        <h2 class="text-xl md:text-2xl font-bold text-slate-800">দোকানের সেটিংস</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="font-bold text-lg mb-4 text-emerald-700">দোকানের তথ্য</h3>
                                <form id="settings-form" onsubmit="saveSettings(event)" class="space-y-4">
                                    <div><label class="block text-sm font-medium text-slate-700 mb-1">দোকানের নাম</label><input type="text" id="setting-shop-name" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none"></div>
                                    <div><label class="block text-sm font-medium text-slate-700 mb-1">প্রোপাইটর / মালিক</label><input type="text" id="setting-proprietor" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none"></div>
                                    <div><label class="block text-sm font-medium text-slate-700 mb-1">মোবাইল নম্বর</label><input type="text" id="setting-mobile" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none"></div>
                                    <button type="submit" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 transition">সেভ করুন</button>
                                </form>
                            </div>
                            <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="font-bold text-lg mb-4 text-red-700">নিরাপত্তা</h3>
                                <form onsubmit="changePassword(event)" class="space-y-4">
                                    <div><label class="block text-sm font-medium text-slate-700 mb-1">বর্তমান পাসওয়ার্ড</label><input type="password" id="current-pin" required class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-red-500 outline-none"></div>
                                    <div><label class="block text-sm font-medium text-slate-700 mb-1">নতুন পাসওয়ার্ড</label><input type="password" id="new-pin" required class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-red-500 outline-none"></div>
                                    <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition">পাসওয়ার্ড পরিবর্তন করুন</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="auth-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm no-print">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-80 relative mx-4">
            <button onclick="closeModal('auth-modal')" class="absolute top-3 right-3 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div id="login-view">
                <h3 class="text-xl font-bold text-center mb-4 text-slate-800">অ্যাডমিন লগইন</h3>
                <p class="text-sm text-slate-500 text-center mb-4">প্যানেলে ঢোকার জন্য পাসওয়ার্ড দিন</p>
                <input type="password" id="auth-pin" class="w-full text-center text-3xl tracking-[0.5em] mb-4 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:outline-none" placeholder="•••••">
                <button onclick="verifyAdmin()" class="w-full py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium text-lg">লগইন</button>
                <div class="mt-4 text-center"><button onclick="toggleForgotPassword(true)" class="text-sm text-blue-600 hover:underline">পাসওয়ার্ড ভুলে গেছেন?</button></div>
            </div>
            <div id="reset-view" class="hidden">
                <h3 class="text-xl font-bold text-center mb-2 text-slate-800">পাসওয়ার্ড রিসেট</h3>
                <p class="text-xs text-center text-slate-500 mb-4">মাস্টার রিসেট কোড দিন</p>
                <input type="text" id="reset-code" class="w-full text-center text-2xl tracking-widest mb-4 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:outline-none" placeholder="****">
                <div class="flex gap-2"><button onclick="toggleForgotPassword(false)" class="flex-1 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">বাতিল</button><button onclick="resetPassword()" class="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">রিসেট</button></div>
            </div>
        </div>
    </div>

    <div id="product-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm no-print">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-slate-800">পণ্য যুক্ত করুন</h3>
            <form id="product-form" onsubmit="handleProductSubmit(event)" class="space-y-3">
                <input type="hidden" id="prod-id">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">পণ্যের নাম</label><input type="text" id="prod-name" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">কেনা দাম</label><input type="number" id="prod-buy" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">বিক্রয় দাম</label><input type="number" id="prod-sell" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">স্টক পরিমাণ</label><input type="number" id="prod-stock" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">অবস্থান</label><input type="text" id="prod-loc" placeholder="যেমন: তাক ১" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></div>
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="closeModal('product-modal')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg border border-slate-300">বাতিল</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">সেভ করুন</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Memo Modal (Thermal Printer Friendly) -->
    <div id="memo-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm no-print">
        <div class="bg-white w-full max-w-[80mm] mx-auto h-[95vh] md:h-auto md:max-h-[90vh] rounded-t-2xl md:rounded-lg shadow-2xl flex flex-col overflow-hidden">
            <div class="bg-slate-100 p-3 border-b flex justify-between items-center shrink-0 no-print">
                <h3 class="font-bold text-slate-700">প্রিভিউ চালান</h3>
                <div class="flex gap-2">
                    <button onclick="printMemo()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700 flex items-center gap-1"><i class="fa-solid fa-print"></i> প্রিন্ট</button>
                    <button onclick="closeModal('memo-modal')" class="bg-red-500 text-white px-3 py-1.5 rounded text-sm hover:bg-red-600"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            
            <div id="memo-print-area" class="flex-1 overflow-y-auto p-4 bg-white text-black font-sans text-sm">
                <div class="text-center mb-4 border-b-2 border-dashed border-slate-800 pb-4">
                    <h1 id="memo-shop-name" class="text-lg font-bold uppercase tracking-wide leading-tight mb-1">দোকানের নাম</h1>
                    <p id="memo-prop" class="text-xs">প্রোপাইটর: নাম</p>
                    <p id="memo-mobile" class="text-xs">মোবাইল: ০১৭১১১১১১১</p>
                    <p class="text-[10px] mt-2 font-bold" id="memo-date">Date: </p>
                    <p class="text-[10px]">Invoice #: <span id="memo-invoice">0000</span></p>
                </div>
                <table class="w-full text-xs mb-4 border-collapse">
                    <thead><tr class="border-b border-slate-800 font-bold"><td class="py-1 text-left w-1/2">বিবরণ</td><td class="py-1 text-center w-1/6">পরিমাণ</td><td class="py-1 text-right w-1/6">দাম</td><td class="py-1 text-right w-1/6">টাকা</td></tr></thead>
                    <tbody id="memo-items"></tbody>
                </table>
                <div class="border-t-2 border-dashed border-slate-800 pt-2">
                    <table class="w-full text-xs">
                        <tr><td class="text-left py-1 font-bold text-lg">সর্বমোট:</td><td class="text-right font-bold text-xl" id="memo-total">৳ ০</td></tr>
                    </table>
                </div>
                <div class="mt-6 pt-2 border-t border-dashed border-slate-300 text-center text-[10px]">
                    <p class="font-bold text-base mb-1">ধন্যবাদ, আবার আসবেন!</p>
                    <p class="text-slate-500">Powered by Grocery POS</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PRINT CONTAINER FOR REPORTS -->
    <div id="report-print-container" class="hidden bg-white text-black p-4 font-sans max-w-[210mm] mx-auto">
        <div class="text-center border-b-2 border-black pb-4 mb-6">
            <h1 id="print-rpt-shop-name" class="text-2xl font-bold uppercase tracking-wide mb-1"></h1>
            <p id="print-rpt-prop" class="text-sm font-semibold mb-1"></p>
            <p id="print-rpt-mobile" class="text-sm"></p>
        </div>
        <div class="mb-6 text-center font-bold text-lg">রিপোর্ট পিরিয়ড: <span id="print-rpt-period"></span></div>
        <div class="grid grid-cols-3 gap-2 mb-6 border border-black p-2 text-center">
            <div class="border-r border-black">
                <p class="text-[10px] font-bold uppercase">মোট বিক্রয়</p>
                <p id="print-rpt-total-sales" class="text-base font-bold mt-1"></p>
            </div>
            <div class="border-r border-black">
                <p class="text-[10px] font-bold uppercase">মোট খরচ</p>
                <p id="print-rpt-total-cost" class="text-base font-bold mt-1"></p>
            </div>
            <div>
                <p class="text-[10px] font-bold uppercase">মোট লাভ</p>
                <p id="print-rpt-profit" class="text-base font-bold mt-1"></p>
            </div>
        </div>
        <div class="mb-2 font-bold text-lg underline">বিক্রয়ের বিস্তারিত তালিকা</div>
        <table class="w-full text-xs border-collapse border border-black mb-6">
            <thead>
                <tr class="bg-slate-200 font-bold border-b border-black">
                    <th class="border border-black p-1 text-left">পণ্যের নাম</th>
                    <th class="border border-black p-1 text-center">পরিমাণ</th>
                    <th class="border border-black p-1 text-right">বিক্রয় মূল্য</th>
                    <th class="border border-black p-1 text-right">সময়</th>
                </tr>
            </thead>
            <tbody id="print-rpt-table-body"></tbody>
        </table>
        <div class="mt-8 pt-2 border-t border-black text-center text-xs">
            <p>প্রিন্ট তারিখ: <span id="print-timestamp"></span></p>
        </div>
    </div>

    <div id="toast-container" class="fixed top-4 right-4 z-[60] flex flex-col gap-2 pointer-events-none no-print"></div>

    <script>
        // ==========================================
        // INIT & LOAD
        // ==========================================
        function init() {
            loadData(); 
            renderProducts();
            renderCart();
            updateSettingsUI();
            document.getElementById('product-search').addEventListener('input', (e) => renderProducts(e.target.value));
        }

        // ==========================================
        // REPORT LOGIC
        // ==========================================
        let currentFilteredSales = [];

        function generateReport(filterType) {
            const dateInput = document.getElementById('report-date').value;
            const monthInput = document.getElementById('report-month').value;
            currentFilteredSales = state.salesHistory;

            if (filterType === 'date' && dateInput) {
                currentFilteredSales = state.salesHistory.filter(s => s.date.startsWith(dateInput));
                document.getElementById('report-month').value = "";
            } else if (filterType === 'month' && monthInput) {
                currentFilteredSales = state.salesHistory.filter(s => s.date.startsWith(monthInput));
                document.getElementById('report-date').value = "";
            }
            renderReportData(currentFilteredSales);
        }

        function renderReportData(sales) {
            const totalSales = sales.reduce((sum, s) => sum + (s.totalSell || 0), 0);
            const totalCost = sales.reduce((sum, s) => sum + (s.totalCost || 0), 0);
            const profit = totalSales - totalCost;

            document.getElementById('report-total-sales').innerText = `৳ ${totalSales.toLocaleString()}`;
            document.getElementById('report-total-cost').innerText = `৳ ${totalCost.toLocaleString()}`;
            document.getElementById('report-profit').innerText = `৳ ${profit.toLocaleString()}`;

            const tbody = document.getElementById('detailed-sales-body');
            tbody.innerHTML = "";
            if(sales.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-slate-400">কোন বিক্রয় পাওয়া যায়নি</td></tr>`;
                return;
            }
            sales.forEach(sale => {
                sale.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-slate-50";
                    const timeStr = new Date(item.time).toLocaleTimeString('bn-BD', {hour: '2-digit', minute:'2-digit', useGrouping: false});
                    row.innerHTML = `<td class="px-4 py-2">${item.name}</td><td class="px-4 py-2 text-center">${item.qty}</td><td class="px-4 py-2 text-right">৳ ${(item.price * item.qty).toLocaleString()}</td><td class="px-4 py-2 text-right text-xs text-slate-500">${timeStr}</td>`;
                    tbody.appendChild(row);
                });
            });
        }

        function clearReportFilters() {
            document.getElementById('report-date').value = "";
            document.getElementById('report-month').value = "";
            generateReport('all');
        }

        function deleteHistoryBasedOnFilter() {
            const dateInput = document.getElementById('report-date').value;
            const monthInput = document.getElementById('report-month').value;

            if (!dateInput && !monthInput) {
                showToast("ডাটা মুছে ফেলার জন্য প্রথমে একটি তারিখ বা মাস সিলেক্ট করুন।", "error");
                return;
            }

            let confirmMsg = "আপনি কি নিশ্চিত যে এই তারিখের সকল ডাটা মুছে ফেলতে চান?";
            if (dateInput) confirmMsg += `\n(নির্দিষ্ট তারিখ: ${dateInput})`;
            else if (monthInput) confirmMsg += `\n(নির্দিষ্ট মাস: ${monthInput})`;

            if (confirm(confirmMsg)) {
                if (dateInput) {
                    state.salesHistory = state.salesHistory.filter(s => !s.date.startsWith(dateInput));
                } else if (monthInput) {
                    state.salesHistory = state.salesHistory.filter(s => !s.date.startsWith(monthInput));
                }
                saveData();
                document.getElementById('report-date').value = "";
                document.getElementById('report-month').value = "";
                generateReport('all');
                showToast("নির্দিষ্ট ইতিহাস মুছে ফেলা হয়েছে", "success");
            }
        }

        // ==========================================
        // PRINT FUNCTIONS
        // ==========================================
        function printSalesReport() {
            document.body.classList.add('printing-report');
            document.body.classList.remove('printing-memo');
            document.getElementById('print-rpt-shop-name').innerText = state.settings.shopName;
            document.getElementById('print-rpt-prop').innerText = `প্রোপাইটর: ${state.settings.proprietor}`;
            document.getElementById('print-rpt-mobile').innerText = `মোবাইল: ${state.settings.mobile}`;
            const dateVal = document.getElementById('report-date').value;
            const monthVal = document.getElementById('report-month').value;
            let tempFilteredSales = state.salesHistory;
            if (dateVal) tempFilteredSales = state.salesHistory.filter(s => s.date.startsWith(dateVal));
            else if (monthVal) tempFilteredSales = state.salesHistory.filter(s => s.date.startsWith(monthVal));
            const totalSales = tempFilteredSales.reduce((sum, s) => sum + (s.totalSell || 0), 0);
            const totalCost = tempFilteredSales.reduce((sum, s) => sum + (s.totalCost || 0), 0);
            const profit = totalSales - totalCost;
            document.getElementById('print-rpt-total-sales').innerText = `৳ ${totalSales.toLocaleString()}`;
            document.getElementById('print-rpt-total-cost').innerText = `৳ ${totalCost.toLocaleString()}`;
            document.getElementById('print-rpt-profit').innerText = `৳ ${profit.toLocaleString()}`;
            let periodText = "সকল সময়ের রিপোর্ট";
            if (monthVal) {
                const bnMonths = ["জানুয়ারি", "ফেব্রুয়ারি", "মার্চ", "এপ্রিল", "মে", "জুন", "জুলাই", "আগস্ট", "সেপ্টেম্বর", "অক্টোবর", "নভেম্বর", "ডিসেম্বর"];
                const [year, monthIndex] = monthVal.split('-');
                periodText = `মাস: ${bnMonths[parseInt(monthIndex) - 1]} ${parseInt(year).toLocaleString('bn-BD', {useGrouping: false})}`;
            } else if (dateVal) {
                periodText = `তারিখ: ${new Date(dateVal).toLocaleDateString('bn-BD', {useGrouping: false})}`;
            }
            document.getElementById('print-rpt-period').innerText = periodText;
            const printTableBody = document.getElementById('print-rpt-table-body');
            printTableBody.innerHTML = "";
            if(tempFilteredSales.length === 0) {
                printTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-2">কোন তথ্য নেই</td></tr>`;
            } else {
                tempFilteredSales.forEach(sale => {
                    sale.items.forEach(item => {
                        const timeStr = new Date(item.time).toLocaleTimeString('bn-BD', {hour: '2-digit', minute:'2-digit', useGrouping: false});
                        const row = `<tr><td class="border border-black p-1 text-left">${item.name}</td><td class="border border-black p-1 text-center">${item.qty}</td><td class="border border-black p-1 text-right">৳ ${(item.price * item.qty).toLocaleString()}</td><td class="border border-black p-1 text-right">${timeStr}</td></tr>`;
                        printTableBody.innerHTML += row;
                    });
                });
            }
            document.getElementById('print-timestamp').innerText = new Date().toLocaleString('bn-BD', {useGrouping: false});
            window.print();
            setTimeout(() => { document.body.classList.remove('printing-report'); }, 1000);
        }

        function printMemo() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('bn-BD', {useGrouping: false});
            const timeStr = now.toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit', useGrouping: false });
            const memoDateEl = document.getElementById('memo-date');
            if(memoDateEl) memoDateEl.innerText = `তারিখ: ${dateStr} ${timeStr}`;
            document.body.classList.add('printing-memo');
            document.body.classList.remove('printing-report');
            window.print();
            setTimeout(() => { document.body.classList.remove('printing-memo'); }, 1000);
        }
        
        // ==========================================
        // CART & PRODUCT LOGIC
        // ==========================================
        
        function goHome() {
            if(state.view === 'admin') state.isAdminUnlocked = false;
            switchView('worker');
        }

        function switchView(viewName) {
            state.view = viewName;
            const workerView = document.getElementById('worker-view');
            const adminView = document.getElementById('admin-view');
            if (viewName === 'admin') {
                workerView.classList.add('hidden');
                adminView.classList.remove('hidden');
                renderInventory();
                generateReport('all');
            } else {
                adminView.classList.add('hidden');
                workerView.classList.remove('hidden');
            }
        }

        function renderProducts(filter = "") {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = "";
            const searchFilter = filter.toLowerCase();
            const filtered = state.products.filter(p => p.name.toLowerCase().includes(searchFilter));
            filtered.forEach(p => {
                const isOutOfStock = p.stock <= 0;
                const card = document.createElement('div');
                card.className = `bg-white rounded-lg shadow-sm border ${isOutOfStock ? 'border-red-200 bg-red-50' : 'border-slate-200'} p-2.5 flex flex-col justify-between hover:shadow-md transition-shadow h-full`;
                card.innerHTML = `
                    <div class="mb-2">
                        <h3 class="font-bold text-slate-800 leading-tight text-sm md:text-base line-clamp-2">${p.name}</h3>
                        <p class="text-[10px] md:text-xs text-slate-500 mt-1">${p.location}</p>
                    </div>
                    <div class="flex items-center justify-between mt-auto">
                        <span class="font-bold text-emerald-600 text-base md:text-lg">৳ ${p.sellPrice}</span>
                        <span class="text-[10px] md:text-xs px-1.5 py-0.5 rounded-full ${isOutOfStock ? 'bg-red-200 text-red-700' : 'bg-slate-100 text-slate-600'}">স্টক: ${p.stock}</span>
                    </div>
                    <button onclick="addToCart(${p.id})" ${isOutOfStock ? 'disabled' : ''} class="mt-3 w-full py-2 rounded-lg font-medium text-xs md:text-sm transition-all border ${isOutOfStock ? 'border-red-200 text-red-400 cursor-not-allowed' : 'border-emerald-600 text-emerald-600 hover:bg-emerald-600 hover:text-white active:scale-95'}">
                        ${isOutOfStock ? 'স্টক নেই' : 'কার্টে যোগ'}
                    </button>`;
                grid.appendChild(card);
            });
        }

        function addToCart(id) {
            const product = state.products.find(p => p.id === id);
            const cartItem = state.cart.find(c => c.id === id);
            const currentQty = cartItem ? cartItem.qty : 0;
            if (currentQty >= product.stock) return showToast("পর্যাপ্ত স্টক নেই!", "error");
            if (cartItem) cartItem.qty++; else state.cart.push({ id, qty: 1 });
            renderCart();
            showToast("তালিকায় যোগ হয়েছে", "success");
        }

        // ==========================================
        // UPDATED CART RENDERING (TOUCH OPTIMIZED)
        // ==========================================
        function renderCart() {
            const container = document.getElementById('cart-items');
            const totalEl = document.getElementById('cart-total');
            const countEl = document.getElementById('cart-count-badge');
            const checkoutBtn = document.getElementById('checkout-btn');
            container.innerHTML = "";
            let totalSell = 0; let totalItems = 0;
            if (state.cart.length === 0) {
                container.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-400"><i class="fa-solid fa-basket-shopping text-3xl opacity-30 mb-2"></i><p class="text-sm">তালিকা খালি</p></div>`;
                checkoutBtn.disabled = true; 
                checkoutBtn.classList.add('opacity-50');
            } else {
                checkoutBtn.disabled = false; 
                checkoutBtn.classList.remove('opacity-50');
                state.cart.forEach(item => {
                    const product = state.products.find(p => p.id === item.id);
                    totalSell += product.sellPrice * item.qty; 
                    totalItems += item.qty;
                    
                    const div = document.createElement('div');
                    div.className = "flex flex-col sm:flex-row items-start sm:items-center justify-between bg-slate-50 p-2 rounded border border-slate-100 gap-2";
                    
                    // Input HTML Structure (Larger buttons for touch)
                    const inputHtml = `
                        <div class="flex items-center gap-1 w-full sm:w-auto justify-between sm:justify-start bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                            <button onclick="updateQty(${item.id}, -1)" class="w-9 h-9 rounded bg-slate-100 hover:bg-red-50 hover:text-red-500 text-slate-600 flex items-center justify-center text-lg font-bold transition-colors">-</button>
                            <input type="number" 
                                value="${item.qty}" 
                                min="1" 
                                max="${product.stock}" 
                                class="w-10 md:w-14 h-8 text-center font-bold text-base bg-transparent focus:outline-none" 
                                oninput="handleQtyInput(${item.id}, this)" 
                                onblur="handleQtyBlur(${item.id}, this)"
                            >
                            <button onclick="updateQty(${item.id}, 1)" class="w-9 h-9 rounded bg-slate-100 hover:bg-emerald-50 hover:text-emerald-600 text-slate-600 flex items-center justify-center text-lg font-bold transition-colors">+</button>
                        </div>
                    `;

                    div.innerHTML = `<div class="flex-1 min-w-0 pr-2"><p class="font-bold text-sm text-slate-800 truncate leading-tight">${product.name}</p><p class="text-xs text-emerald-600 mt-0.5">৳ ${product.sellPrice} x ${item.qty}</p></div>${inputHtml}`;
                    container.appendChild(div);
                });
            }
            totalEl.innerText = `৳ ${totalSell.toLocaleString()}`; 
            countEl.innerText = `${totalItems} টি`;
        }

        function updateQty(id, change) {
            const item = state.cart.find(c => c.id === id);
            const product = state.products.find(p => p.id === id);
            if (!item) return;
            if (change > 0 && item.qty >= product.stock) return showToast("ম্যাক্স স্টক অতিক্রম করতে পারবেন না", "error");
            item.qty += change;
            if (item.qty <= 0) state.cart = state.cart.filter(c => c.id !== id);
            renderCart();
        }

        function handleQtyInput(id, inputEl) {
            const item = state.cart.find(c => c.id === id);
            const val = parseInt(inputEl.value);
            if (!item) return;
            if (!isNaN(val) && val > 0) {
                item.qty = val;
                updateCartTotals();
            }
        }

        function handleQtyBlur(id, inputEl) {
            const item = state.cart.find(c => c.id === id);
            const product = state.products.find(p => p.id === id);
            let val = parseInt(inputEl.value);

            if (!item || !product) return;

            if (isNaN(val) || val <= 0) {
                if (val === 0) {
                    if (confirm("পরিমাণ ০ করা হয়েছে। আইটেমটি তালিকা থেকে সরাতে চান?")) {
                        state.cart = state.cart.filter(c => c.id !== id);
                    } else {
                        renderCart();
                        return;
                    }
                } else {
                    item.qty = 1;
                }
            } else if (val > product.stock) {
                showToast(`সর্বোচ্চ স্টক ${product.stock}`, "error");
                item.qty = product.stock;
            } else {
                item.qty = val;
            }
            renderCart();
        }

        function updateCartTotals() {
            let total = 0;
            let count = 0;
            state.cart.forEach(item => {
                const p = state.products.find(prod => prod.id === item.id);
                if(p) {
                    total += p.sellPrice * item.qty;
                    count += item.qty;
                }
            });
            document.getElementById('cart-total').innerText = `৳ ${total.toLocaleString()}`;
            document.getElementById('cart-count-badge').innerText = `${count} টি`;
        }

        function clearCart(e) { if(e) e.stopPropagation(); if(confirm("সমস্ত তালিকা মুছে ফেলতে চান?")) { state.cart = []; renderCart(); } }

        function handleCheckout() {
            if (state.cart.length === 0) return;
            let totalSell = 0, totalCost = 0;
            const memoItems = [], historyItems = [];
            [...state.cart].forEach(item => {
                const product = state.products.find(p => p.id === item.id);
                const itemSell = product.sellPrice * item.qty;
                const itemCost = product.buyPrice * item.qty;
                totalSell += itemSell; totalCost += itemCost; product.stock -= item.qty;
                memoItems.push({ name: product.name, qty: item.qty, rate: product.sellPrice, total: itemSell });
                historyItems.push({ name: product.name, qty: item.qty, price: product.sellPrice, time: new Date().toISOString() });
            });
            const profit = totalSell - totalCost;
            state.salesHistory.push({ id: Date.now(), date: new Date().toISOString(), items: historyItems, totalSell, totalCost, profit });
            saveData();
            showMemo(memoItems, totalSell);
            state.cart = []; renderCart(); renderProducts();
        }

        function showMemo(items, total) {
            const modal = document.getElementById('memo-modal');
            const list = document.getElementById('memo-items');
            document.getElementById('memo-shop-name').innerText = state.settings.shopName;
            document.getElementById('memo-prop').innerText = `প্রোপাইটর: ${state.settings.proprietor}`;
            document.getElementById('memo-mobile').innerText = `মোবাইল: ${state.settings.mobile}`;
            const now = new Date();
            document.getElementById('memo-date').innerText = `তারিখ: ${now.toLocaleDateString('bn-BD', {useGrouping: false})} ${now.toLocaleTimeString('bn-BD', {hour: '2-digit', minute:'2-digit', useGrouping: false})}`;
            document.getElementById('memo-invoice').innerText = Math.floor(Math.random() * 9000) + 1000;
            document.getElementById('memo-total').innerText = `৳ ${total.toLocaleString()}`;
            list.innerHTML = items.map(item => `<tr class="border-b border-dashed border-slate-300"><td class="py-1 pl-1 align-top leading-tight">${item.name}</td><td class="py-1 text-center align-top">${item.qty}</td><td class="py-1 text-right align-top">${item.rate}</td><td class="py-1 pr-1 text-right align-top font-medium">${item.total}</td></tr>`).join('');
            modal.classList.remove('hidden');
        }

        function toggleAdminAuth() {
            if (state.isAdminUnlocked) switchView('admin');
            else { document.getElementById('auth-modal').classList.remove('hidden'); document.getElementById('auth-pin').focus(); }
        }

        function verifyAdmin() {
            if (document.getElementById('auth-pin').value === state.settings.pin) {
                state.isAdminUnlocked = true; closeModal('auth-modal'); switchView('admin'); showToast("স্বাগতম, অ্যাডমিন", "success"); document.getElementById('auth-pin').value = '';
            } else showToast("ভুল পাসওয়ার্ড!", "error");
        }

        function exitAdminMode() { state.isAdminUnlocked = false; switchView('worker'); showToast("লগআউট সফল", "info"); }
        function toggleForgotPassword(show) { if(show) { document.getElementById('login-view').classList.add('hidden'); document.getElementById('reset-view').classList.remove('hidden'); } else { document.getElementById('login-view').classList.remove('hidden'); document.getElementById('reset-view').classList.add('hidden'); } }
        function resetPassword() { const code = document.getElementById('reset-code').value; if(code === CONFIG.MASTER_RESET_CODE) { state.settings.pin = CONFIG.DEFAULT_PIN; saveData(); showToast("পাসওয়ার্ড ডিফল্ট (1234) সেট হয়েছে", "success"); toggleForgotPassword(false); closeModal('auth-modal'); } else showToast("ভুল মাস্টার কোড!", "error"); }
        function changePassword(e) {
            e.preventDefault();
            const current = document.getElementById('current-pin').value; const newPin = document.getElementById('new-pin').value;
            if(current !== state.settings.pin) return showToast("বর্তমান পাসওয়ার্ড ভুল!", "error");
            if(newPin.length < 4) return showToast("পাসওয়ার্ড কমপক্ষে ৪ ডিজিট হতে হবে", "error");
            state.settings.pin = newPin; saveData(); showToast("পাসওয়ার্ড পরিবর্তন সফল", "success"); e.target.reset();
        }
        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.admin-tab').forEach(el => { el.classList.remove('bg-slate-800', 'text-white', 'border-emerald-500'); el.classList.add('border-transparent'); });
            const btn = Array.from(document.querySelectorAll('.admin-tab')).find(b => b.onclick.toString().includes(tab));
            if(btn) { btn.classList.add('bg-slate-800', 'text-white', 'border-emerald-500'); btn.classList.remove('border-transparent'); }
        }
        function renderInventory() {
            const tbody = document.getElementById('inventory-table-body'); tbody.innerHTML = "";
            state.products.forEach(p => {
                const tr = document.createElement('tr'); tr.className = "border-b hover:bg-slate-50";
                tr.innerHTML = `<td class="px-4 py-3 font-medium whitespace-nowrap">${p.name}</td><td class="px-4 py-3">৳ ${p.buyPrice}</td><td class="px-4 py-3 text-emerald-600 font-bold">৳ ${p.sellPrice}</td><td class="px-4 py-3">${p.stock}</td><td class="px-4 py-3 text-sm text-slate-500">${p.location}</td><td class="px-4 py-3 text-right"><button onclick="editProduct(${p.id})" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fa-solid fa-pen"></i></button><button onclick="deleteProduct(${p.id})" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }
        function openProductModal(id = null) {
            const modal = document.getElementById('product-modal'); const form = document.getElementById('product-form'); form.reset();
            if (id) {
                const p = state.products.find(x => x.id === id);
                document.getElementById('prod-id').value = p.id; document.getElementById('prod-name').value = p.name; document.getElementById('prod-buy').value = p.buyPrice; document.getElementById('prod-sell').value = p.sellPrice; document.getElementById('prod-stock').value = p.stock; document.getElementById('prod-loc').value = p.location; document.getElementById('modal-title').innerText = "পণ্য এডিট করুন";
            } else { document.getElementById('prod-id').value = ""; document.getElementById('modal-title').innerText = "নতুন পণ্য যুক্ত করুন"; }
            modal.classList.remove('hidden');
        }
        function editProduct(id) { openProductModal(id); }
        function deleteProduct(id) { if(confirm("এই পণ্যটি মুছে ফেলতে চান?")) { state.products = state.products.filter(p => p.id !== id); saveData(); renderInventory(); renderProducts(); showToast("পণ্য মুছে ফেলা হয়েছে", "success"); } }
        function handleProductSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('prod-id').value; const name = document.getElementById('prod-name').value; const buy = parseFloat(document.getElementById('prod-buy').value); const sell = parseFloat(document.getElementById('prod-sell').value); const stock = parseInt(document.getElementById('prod-stock').value); const loc = document.getElementById('prod-loc').value;
            if (id) { const p = state.products.find(x => x.id == id); Object.assign(p, { name, buyPrice: buy, sellPrice: sell, stock, location: loc }); showToast("আপডেট সফল হয়েছে", "success"); }
            else { const newId = Date.now(); state.products.push({ id: newId, name, buyPrice: buy, sellPrice: sell, stock, location: loc }); showToast("পণ্য যুক্ত হয়েছে", "success"); }
            saveData(); closeModal('product-modal'); renderInventory(); renderProducts();
        }

        function saveSettings(e) {
            e.preventDefault();
            state.settings.shopName = document.getElementById('setting-shop-name').value;
            state.settings.proprietor = document.getElementById('setting-proprietor').value;
            state.settings.mobile = document.getElementById('setting-mobile').value;
            saveData(); updateSettingsUI(); showToast("সেটিংস সেভ হয়েছে", "success");
        }

        function updateSettingsUI() {
            document.getElementById('setting-shop-name').value = state.settings.shopName;
            document.getElementById('setting-proprietor').value = state.settings.proprietor;
            document.getElementById('setting-mobile').value = state.settings.mobile;
            document.getElementById('shop-name-header').innerText = state.settings.shopName;
            document.getElementById('shop-prop-header').innerText = `প্রোপাইটর: ${state.settings.proprietor}`;
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function toggleMobileCart() { 
            const panel = document.getElementById('cart-panel'); 
            const icon = document.getElementById('mobile-cart-icon'); 
            panel.classList.toggle('translate-y-full'); 
            icon.classList.toggle('rotate-180'); 
        }
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container'); const div = document.createElement('div');
            const color = type === 'success' ? 'bg-emerald-600' : (type === 'error' ? 'bg-red-500' : 'bg-slate-800');
            div.className = `${color} text-white px-4 py-3 rounded shadow-lg text-sm font-medium fade-in max-w-[80%]`;
            div.innerText = msg; container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        init();
    </script>
</body>
</html>
