<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Website Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* CRITICAL: Full Screen Layout */
        body { 
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            background-color: #0b0f1a; 
            margin: 0; 
            color: #e2e8f0;
        }

        /* ChatGPT Style Chat Bubbles */
        .message-user { background: #2563eb; color: white; border-radius: 15px 15px 2px 15px; align-self: flex-end; }
        .message-ai { background: #1e293b; color: #cbd5e1; border-radius: 15px 15px 15px 2px; align-self: flex-start; border: 1px solid #334155; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        /* Split Screen logic */
        main { display: flex; flex: 1; min-height: 0; }
        #chat-section { width: 350px; display: flex; flex-direction: column; border-right: 1px solid #1e293b; background: #0f172a; }
        #preview-section { flex: 1; background: #020617; padding: 15px; position: relative; }
        
        iframe { background: white; border-radius: 12px; width: 100%; height: 100%; border: none; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        .sidebar-collapsed #chat-section { display: none; }
        
        /* Mobile adjustment */
        @media (max-width: 768px) {
            #chat-section { width: 100%; position: absolute; z-index: 40; height: 100%; }
            .hidden-mobile { display: none; }
        }
    </style>
</head>
<body>

    <!-- TOP HEADER -->
    <header class="h-14 border-b border-slate-800 flex items-center justify-between px-4 bg-slate-900/80 backdrop-blur-md flex-shrink-0">
        <div class="flex items-center gap-3">
            <button onclick="createNewProject()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-all">
                <i data-lucide="plus" class="w-4 h-4"></i> New Website
            </button>
            <div class="h-6 w-[1px] bg-slate-700 hidden md:block"></div>
            <span id="project-title" class="text-slate-400 text-sm font-medium truncate max-w-[150px]">Project: Untitled</span>
        </div>

        <div class="flex items-center gap-2">
            <div class="bg-slate-800 rounded-lg p-1 flex border border-slate-700">
                <button id="btn-preview" onclick="toggleView('preview')" class="px-4 py-1 text-xs font-bold rounded-md bg-blue-600 text-white">PREVIEW</button>
                <button id="btn-code" onclick="toggleView('code')" class="px-4 py-1 text-xs font-bold rounded-md text-slate-400">CODE</button>
            </div>
            <button onclick="toggleSettings(true)" class="p-2 text-slate-400 hover:text-white"><i data-lucide="settings" class="w-5 h-5"></i></button>
            <button onclick="downloadCode()" class="bg-slate-800 p-2 rounded-lg text-slate-300 border border-slate-700"><i data-lucide="download" class="w-5 h-5"></i></button>
        </div>
    </header>

    <main>
        <!-- LEFT: CHAT INTERFACE (ChatGPT Style) -->
        <section id="chat-section">
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar flex flex-col">
                <div class="message-ai p-3 text-sm">
                    Hello! Describe the website you want to build, and I will create it live on the right side.
                </div>
            </div>
            
            <!-- INPUT AREA -->
            <div class="p-4 border-t border-slate-800 bg-slate-900/50">
                <div class="relative">
                    <textarea id="user-input" rows="1" placeholder="Type instructions..." 
                        class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all resize-none pr-12"
                        oninput="this.style.height = ''; this.style.height = Math.min(this.scrollHeight, 150) + 'px'"></textarea>
                    <button id="send-btn" onclick="handleSend()" class="absolute right-2 bottom-2 p-2 bg-blue-600 rounded-lg text-white hover:bg-blue-500 disabled:opacity-50">
                        <i data-lucide="arrow-up" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- RIGHT: LIVE PREVIEW -->
        <section id="preview-section">
            <div id="view-iframe" class="h-full w-full">
                <iframe id="preview-frame"></iframe>
            </div>
            <div id="view-code" class="h-full w-full hidden">
                <textarea id="code-editor" class="w-full h-full bg-slate-950 text-blue-300 p-6 font-mono text-sm border border-slate-800 rounded-xl outline-none resize-none" spellcheck="false"></textarea>
            </div>
        </section>
    </main>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-md rounded-2xl p-6">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="key" class="text-blue-500"></i> API Settings</h2>
            <div class="space-y-4">
                <input type="text" id="set-url" placeholder="API URL" class="w-full bg-slate-950 border border-slate-800 rounded-lg px-4 py-2 text-sm">
                <input type="password" id="set-key" placeholder="OpenRouter API Key" class="w-full bg-slate-950 border border-slate-800 rounded-lg px-4 py-2 text-sm">
                <input type="text" id="set-model" placeholder="Model ID" class="w-full bg-slate-950 border border-slate-800 rounded-lg px-4 py-2 text-sm">
            </div>
            <div class="mt-6 flex gap-2">
                <button onclick="saveSettings()" class="flex-1 bg-blue-600 py-2 rounded-lg font-bold">Save</button>
                <button onclick="toggleSettings(false)" class="flex-1 bg-slate-800 py-2 rounded-lg font-bold">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const SYSTEM_PROMPT = "You are an AI Website Builder. Output ONLY raw HTML/Tailwind CSS code. Do not include markdown (```), do not include <think> tags, and do not explain your work. If the user asks for changes, rewrite the code to incorporate them.";
        const DEFAULTS = { url: "https://openrouter.ai/api/v1/chat/completions", key: "", model: "deepseek/deepseek-r1:free" };

        let state = {
            history: [],
            currentCode: `<html><script src="https://cdn.tailwindcss.com"><\/script><body class="bg-slate-100 flex items-center justify-center h-screen font-sans"><div class="text-center text-slate-400"><h1>Website Preview will appear here</h1></div></body></html>`,
            settings: JSON.parse(localStorage.getItem('builder_settings')) || DEFAULTS
        };

        window.onload = () => {
            lucide.createIcons();
            document.getElementById('preview-frame').srcdoc = state.currentCode;
            document.getElementById('set-url').value = state.settings.url;
            document.getElementById('set-key').value = state.settings.key;
            document.getElementById('set-model').value = state.settings.model;
        };

        async function handleSend() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text || !state.settings.key) { if(!state.settings.key) toggleSettings(true); return; }

            // 1. Add to UI
            addChatMessage('user', text);
            input.value = "";
            input.style.height = 'auto';

            try {
                setLoading(true);
                
                // 2. Build ChatGPT-style history
                const messages = [
                    { role: "system", content: SYSTEM_PROMPT + "\n\nCurrent Website Code:\n" + state.currentCode },
                    ...state.history,
                    { role: "user", content: text }
                ];

                const response = await fetch(state.settings.url, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${state.settings.key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: state.settings.model, messages: messages })
                });

                // 3. Anti-Crash & Thinking Removal Logic
                const rawText = await response.text();
                if (!response.ok) { alert("Error: " + rawText); return; }
                
                const data = JSON.parse(rawText);
                let content = data.choices[0].message.content;

                // REMOVE THINKING TAGS (the text in your screenshot)
                content = content.replace(/<think>[\s\S]*?<\/think>/gi, '');
                // REMOVE MARKDOWN
                content = content.replace(/```html/gi, '').replace(/```/g, '').trim();
                // REMOVE CITATIONS
                content = content.replace(/\[\[\d+\]\(https?:\/\/[^\)]+\)\]/g, '');

                // 4. Update Preview
                state.currentCode = content;
                state.history.push({ role: "user", content: text });
                state.history.push({ role: "assistant", content: "Website updated." });
                
                document.getElementById('preview-frame').srcdoc = content;
                document.getElementById('code-editor').value = content;
                addChatMessage('ai', "I've updated the website for you!");

            } catch (err) {
                alert("Critical Error: " + err.message);
            } finally {
                setLoading(false);
            }
        }

        function addChatMessage(role, text) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `p-3 text-sm ${role === 'user' ? 'message-user' : 'message-ai'}`;
            div.textContent = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function toggleView(view) {
            const isPreview = view === 'preview';
            document.getElementById('view-iframe').classList.toggle('hidden', !isPreview);
            document.getElementById('view-code').classList.toggle('hidden', isPreview);
            document.getElementById('btn-preview').className = isPreview ? 'px-4 py-1 text-xs font-bold rounded-md bg-blue-600 text-white' : 'px-4 py-1 text-xs font-bold rounded-md text-slate-400';
            document.getElementById('btn-code').className = !isPreview ? 'px-4 py-1 text-xs font-bold rounded-md bg-blue-600 text-white' : 'px-4 py-1 text-xs font-bold rounded-md text-slate-400';
            if(!isPreview) document.getElementById('code-editor').value = state.currentCode;
        }

        function saveSettings() {
            state.settings = { 
                url: document.getElementById('set-url').value, 
                key: document.getElementById('set-key').value, 
                model: document.getElementById('set-model').value 
            };
            localStorage.setItem('builder_settings', JSON.stringify(state.settings));
            toggleSettings(false);
        }

        function createNewProject() {
            if(confirm("Start a new project? Current work will be lost.")) {
                location.reload();
            }
        }

        function toggleSettings(show) { document.getElementById('settings-modal').classList.toggle('hidden', !show); }
        function downloadCode() {
            const blob = new Blob([state.currentCode], { type: 'text/html' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'index.html'; a.click();
        }
        function setLoading(l) { 
            const b = document.getElementById('send-btn');
            b.disabled = l;
            b.innerHTML = l ? '<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>' : '<i data-lucide="arrow-up" class="w-5 h-5"></i>';
            lucide.createIcons();
        }
    </script>
</body>
</html>
