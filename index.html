<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>মদির দোকান</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts for Bengali -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: 'Hind Siliguri', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* Input Number Arrows Remove */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }

        /* ==========================================
           IMPROVED PRINT STYLES (THERMAL PRINTER READY)
           ========================================== */
        @media print {
            @page {
                size: 80mm auto; /* Standard Thermal Printer Width */
                margin: 0;
            }
            body { 
                background: white; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
            }
            
            /* Hide UI Elements */
            body > * { display: none !important; }
            .no-print { display: none !important; }

            /* Show Memo Only */
            body.printing-memo #memo-modal {
                display: block !important;
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: white !important; z-index: 9999; overflow: visible;
            }
            body.printing-memo #memo-modal > div {
                box-shadow: none !important; border: none !important; width: 100% !important;
                max-width: 100% !important; height: auto !important; border-radius: 0 !important;
                margin: 0 !important; display: block !important;
            }
            body.printing-memo #memo-modal > div > div:first-child { display: none !important; } /* Hide Modal Header */
            body.printing-memo #memo-print-area {
                display: block !important; position: relative; width: 100%;
                color: black !important; background: white !important; border: none !important;
                padding: 10px !important; overflow: visible !important; font-size: 12px;
            }

            /* Show Report Only */
            body.printing-report #report-print-container {
                display: block !important; position: absolute; top: 0; left: 0; width: 100%;
                background: white !important; color: black !important; z-index: 9999;
                padding: 10px !important; margin: 0 !important; height: auto !important;
                overflow: visible !important; border: none !important; box-shadow: none !important;
                font-size: 12px;
            }

            /* Force Text Colors */
            body.printing-report #report-print-container *, 
            body.printing-memo #memo-print-area * {
                color: #000 !important; border-color: #000 !important;
                text-shadow: none !important; box-shadow: none !important;
            }
        }

        /* Smooth Transitions */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Bottom Sheet Shadow */
        .bottom-sheet-shadow {
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ==========================================
           LOGIN TAB STYLES (Custom Logic)
           ========================================== */
        .login-tab-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Worker Active State: Emerald */
        .login-tab-btn.worker-active {
            background-color: #059669; /* Emerald 600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.3);
            font-weight: 700;
        }

        /* Admin Active State: Slate/Dark */
        .login-tab-btn.admin-active {
            background-color: #1e293b; /* Slate 800 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(30, 41, 59, 0.3);
            font-weight: 700;
        }

        /* Inactive State */
        .login-tab-btn:not(.worker-active):not(.admin-active) {
            background-color: transparent;
            color: #64748b; /* Slate 500 */
            font-weight: 500;
        }
        .login-tab-btn:not(.worker-active):not(.admin-active):hover {
            background-color: #f1f5f9; /* Slate 100 */
            color: #334155;
        }
    </style>
    
    <script>
        // ==========================================
        // CONFIGURATION & STATE INIT
        // ==========================================
        const CONFIG = {
            DEFAULT_PIN: "1234",
            WORKER_DEFAULT_PIN: "1234", 
            MASTER_RESET_CODE: "00000" 
        };

        // Initialize Supabase Client
        const supabaseUrl = 'https://dpvairveaqyuwewivaku.supabase.co';
        const supabaseKey = 'sb_publishable_5ZTEbRp_b0_sMd4qWCRF_w_ksT9eg24';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Default State Structure
        const state = {
            products: [],
            cart: [],
            salesHistory: [], 
            settings: {
                shopName: "আপনার দোকান",
                proprietor: "প্রোপাইটর নাম",
                mobile: "01700000000",
                pin: CONFIG.DEFAULT_PIN,
                worker_pin: CONFIG.WORKER_DEFAULT_PIN 
            },
            currentUser: null 
        };

        // ==========================================
        // DATA FETCHING (Supabase)
        // ==========================================
        async function fetchData() {
            try {
                // 1. Fetch Products
                const { data: products, error: prodError } = await _supabase
                    .from('products')
                    .select('*');
                
                if (prodError) throw prodError;
                state.products = products || [];

                // 2. Fetch Sales History
                const { data: sales, error: salesError } = await _supabase
                    .from('sales_history')
                    .select('*')
                    .order('date', { ascending: false });

                if (salesError) throw salesError;
                state.salesHistory = sales || [];

                // 3. Fetch Settings
                const { data: settingsData, error: settingsError } = await _supabase
                    .from('settings')
                    .select('*')
                    .limit(1);

                if (settingsError) throw settingsError;

                if (settingsData && settingsData.length > 0) {
                    state.settings = settingsData[0];
                    if (!state.settings.worker_pin) {
                        state.settings.worker_pin = CONFIG.WORKER_DEFAULT_PIN;
                        _supabase.from('settings').update({ worker_pin: CONFIG.WORKER_DEFAULT_PIN }).eq('id', state.settings.id);
                    }
                } else {
                    const { error: insertError } = await _supabase
                        .from('settings')
                        .insert([{
                            shopName: state.settings.shopName,
                            proprietor: state.settings.proprietor,
                            mobile: state.settings.mobile,
                            pin: state.settings.pin,
                            worker_pin: CONFIG.WORKER_DEFAULT_PIN
                        }]);
                    if (insertError) console.error("Failed to create default settings", insertError);
                }

                // Hide loading screen only after data fetch
                document.getElementById('loading-screen').classList.add('hidden');
                
                // If app is already visible (after login), render
                if(!document.getElementById('app').classList.contains('hidden')){
                    renderProducts();
                    renderCart();
                    updateSettingsUI();
                }

            } catch (err) {
                console.error("Data Load Error:", err);
                showToast("ডাটাবেস লোড করতে সমস্যা হয়েছে!", "error");
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }
    </script>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- ==========================================
         LOGIN SCREEN (Redesigned for Mobile & UX)
         ========================================== -->
    <!-- Fixed: min-h-screen, flex-col, justify-center ensures perfect centering. 
         overflow-y-auto handles scrolling when keyboard is up or content is long. -->
    <div id="login-screen" class="fixed inset-0 z-[200] bg-slate-50/95 backdrop-blur-sm min-h-screen flex flex-col items-center justify-center py-6 px-4 overflow-y-auto hidden">
        
        <!-- Login Card: Max width constrained, rounded corners, premium shadow -->
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden border border-slate-100/50 relative transform transition-all">
            
            <!-- Header Section: Clean, Professional (Slightly smaller on mobile) -->
            <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 p-5 md:p-8 text-center text-white relative overflow-hidden">
                <!-- Decorative Circle -->
                <div class="absolute top-0 right-0 -mr-8 -mt-8 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                
                <div class="w-16 h-16 md:w-20 md:h-20 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-3 md:mb-4 backdrop-blur-md border-2 border-white/20 shadow-lg">
                    <i class="fa-solid fa-store text-3xl md:text-4xl text-white"></i>
                </div>
                <h1 class="text-2xl md:text-3xl font-bold mb-1 tracking-tight">মদির দোকান</h1>
                <p class="text-emerald-100 text-xs md:text-sm font-medium leading-relaxed">স্বাগতম! দয়া করে লগইন করুন</p>
            </div>

            <!-- Login Switcher (Tabs) -->
            <div class="px-4 py-3 bg-slate-50 border-b border-slate-100 flex justify-center">
                <div class="bg-slate-200 p-1 rounded-xl inline-flex w-full relative shadow-inner">
                    <!-- Worker Tab -->
                    <button id="btn-login-worker" onclick="toggleLoginView('worker')" class="login-tab-btn worker-active flex-1 py-2.5 rounded-lg font-bold text-sm md:text-base leading-relaxed flex items-center justify-center gap-2 transition-all">
                        <i class="fa-solid fa-user-check"></i> ওয়ার্কার
                    </button>
                    <!-- Admin Tab -->
                    <button id="btn-login-admin" onclick="toggleLoginView('admin')" class="login-tab-btn flex-1 py-2.5 rounded-lg font-bold text-sm md:text-base leading-relaxed flex items-center justify-center gap-2 transition-all">
                        <i class="fa-solid fa-user-tie"></i> অ্যাডমিন
                    </button>
                </div>
            </div>

            <!-- Forms Container -->
            <div class="p-5 md:p-8 bg-white min-h-[280px]">
                
                <!-- 1. WORKER LOGIN FORM -->
                <div id="worker-login-panel" class="animate-fade-in h-full flex flex-col justify-center">
                    <h2 class="text-lg md:text-xl font-bold text-emerald-800 mb-5 text-center flex items-center justify-center gap-2 leading-relaxed">
                        <i class="fa-solid fa-key text-emerald-600"></i> ওয়ার্কার পিন দিন
                    </h2>
                    <div class="space-y-4">
                        <div class="relative group">
                            <span class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within:text-emerald-500 transition-colors"><i class="fa-solid fa-lock"></i></span>
                            <input type="password" id="worker-login-pin" class="w-full pl-12 pr-4 py-3.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent text-lg tracking-[0.2em] text-center transition-all font-medium leading-relaxed" placeholder="•••••">
                        </div>
                        
                        <button onclick="performLogin('worker')" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-emerald-200 transition-all active:scale-[0.98] text-lg leading-relaxed">
                            লগইন করুন
                        </button>
                    </div>
                </div>

                <!-- 2. ADMIN LOGIN FORM -->
                <!-- Updated: Added 'relative' to parent for absolute positioning of the icon -->
                <div id="admin-login-panel" class="hidden animate-fade-in h-full flex flex-col relative">
                    
                    <!-- New Trigger Icon: Absolute positioned at top-right -->
                    <button onclick="openMasterCodeModal()" class="absolute top-0 right-0 p-2 text-slate-400 hover:text-blue-600 hover:rotate-90 transition-all duration-300 focus:outline-none z-10" title="মাস্টার কোড">
                        <i class="fa-solid fa-gear text-lg"></i>
                    </button>

                    <h2 class="text-lg md:text-xl font-bold text-slate-800 mb-5 text-center flex items-center justify-center gap-2 leading-relaxed">
                        <i class="fa-solid fa-shield-halved text-slate-700"></i> অ্যাডমিন পিন দিন
                    </h2>
                    <div class="space-y-4">
                        <div class="relative group">
                            <span class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within:text-slate-600 transition-colors"><i class="fa-solid fa-fingerprint"></i></span>
                            <input type="password" id="admin-login-pin" class="w-full pl-12 pr-4 py-3.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent text-lg tracking-[0.2em] text-center transition-all font-medium leading-relaxed" placeholder="•••••">
                        </div>
                        
                        <button onclick="performLogin('admin')" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-slate-200 transition-all active:scale-[0.98] text-lg leading-relaxed">
                            অ্যাডমিন প্যানেলে যান
                        </button>
                    </div>

                    <!-- Removed: Text link at bottom (Replaced by gear icon above) -->
                </div>
                
                <!-- Version Footer -->
                <div class="mt-6 text-center">
                </div>
            </div>
        </div>
    </div>

    <!-- ==========================================
         MASTER CODE MODAL (Modern & Premium)
         ========================================== -->
    <div id="master-code-modal" class="fixed inset-0 z-[300] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <!-- Modal Content: Scale animation on open -->
        <div class="bg-white w-full max-w-sm mx-5 rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-95 duration-300 border border-white/50" id="master-code-content">
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-6 text-center relative">
                <button onclick="closeMasterCodeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
                <div class="w-14 h-14 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-3 border border-white/10 shadow-inner">
                    <i class="fa-solid fa-user-shield text-2xl text-blue-300"></i>
                </div>
                <h3 class="text-lg font-bold text-white tracking-wide">মাস্টার কোড দিন</h3>
            </div>

            <!-- Body -->
            <div class="p-6 md:p-8">
                <p class="text-slate-500 text-sm mb-6 text-center leading-relaxed">পাসওয়ার্ড পুনরুদ্ধারের জন্য গোপন কোড প্রদান করুন।</p>
                
                <div class="relative mb-6">
                    <input type="password" id="master-code-input" class="w-full px-4 py-3.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-center text-lg tracking-widest font-bold text-slate-800 transition-all leading-relaxed" placeholder="*****">
                </div>
                
                <!-- Result Display Area -->
                <div id="master-code-result" class="mb-6 text-sm hidden rounded-xl overflow-hidden shadow-sm border break-words leading-relaxed"></div>
                
                <!-- Actions -->
                <div class="flex gap-3">
                    <button onclick="closeMasterCodeModal()" class="flex-1 bg-slate-100 text-slate-600 hover:bg-slate-200 font-bold py-3 rounded-xl transition-colors text-sm">বন্ধ</button>
                    <button onclick="checkMasterCode()" class="flex-1 bg-blue-600 text-white hover:bg-blue-700 font-bold py-3 rounded-xl transition-all shadow-lg shadow-blue-200 active:scale-[0.98] text-sm">চেক করুন</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-slate-600 font-medium leading-relaxed">সার্ভারের সাথে সংযোগ হচ্ছে...</p>
    </div>

    <div id="app" class="flex flex-col h-full w-full relative hidden">
        
        <!-- HEADER -->
        <header class="bg-emerald-700 text-white shadow-md z-20 shrink-0 select-none no-print">
            <div class="max-w-7xl mx-auto px-3 h-14 md:h-16 flex items-center justify-between">
                <div class="flex items-center gap-2 md:gap-3">
                    <i class="fa-solid fa-shop text-xl md:text-2xl text-emerald-300"></i>
                    <div>
                        <h1 id="shop-name-header" class="font-bold text-lg md:text-xl leading-tight truncate max-w-[150px] md:max-w-none">আপনার দোকান</h1>
                        <p id="shop-prop-header" class="text-[10px] md:text-xs text-emerald-200 hidden sm:block">প্রোপাইটর: নাম লিখুন</p>
                    </div>
                </div>
                
                <!-- Admin Only: Settings Button (Hidden for Workers) -->
                <button id="header-settings-btn" onclick="event.stopPropagation(); toggleAdminAuth()" class="p-2 rounded-full hover:bg-emerald-800 transition-colors active:scale-95 hidden" title="সেটিংস">
                    <i class="fa-solid fa-gear text-lg md:text-xl"></i>
                </button>

                <!-- Logout Button (Always visible if logged in) -->
                <button onclick="event.stopPropagation(); logout()" class="ml-2 p-2 rounded-full hover:bg-red-600 transition-colors active:scale-95" title="লগআউট">
                    <i class="fa-solid fa-right-from-bracket text-lg md:text-xl"></i>
                </button>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main id="main-content" class="flex-1 flex overflow-hidden relative no-print">
            
            <!-- WORKER VIEW (Default for workers, accessible for admin) -->
            <div id="worker-view" class="flex flex-col md:flex-row w-full h-full">
                
                <!-- Product Grid Section -->
                <div class="flex-1 flex flex-col h-full bg-slate-50 overflow-hidden relative">
                    <!-- Search Bar -->
                    <div class="p-3 bg-white shadow-sm z-10 shrink-0">
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><i class="fa-solid fa-magnifying-glass"></i></span>
                            <input type="text" id="product-search" placeholder="পণ্য খুঁজুন..." 
                                class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm md:text-base text-slate-700 shadow-sm leading-relaxed">
                        </div>
                    </div>

                    <!-- Grid: 2 cols on mobile, 4 on PC -->
                    <div id="product-grid" class="flex-1 overflow-y-auto p-2 md:p-3 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-3 content-start pb-24 md:pb-10"></div>
                </div>

                <!-- Cart Panel (Bottom Sheet on Mobile, Sidebar on Desktop) -->
                <div id="cart-panel" class="w-full md:w-96 bg-white border-l border-slate-200 flex flex-col shadow-2xl z-50 fixed md:relative bottom-0 h-[55vh] md:h-full transform translate-y-full md:translate-y-0 transition-transform duration-300 ease-out rounded-t-2xl md:rounded-none bottom-sheet-shadow">
                    
                    <!-- Mobile Handle -->
                    <div class="md:hidden w-full flex flex-col items-center pt-2 pb-1 cursor-grab active:cursor-grabbing bg-slate-50" onclick="toggleMobileCart()">
                        <div class="w-12 h-1.5 bg-slate-400 rounded-full mb-2"></div>
                    </div>

                    <!-- Cart Header -->
                    <div class="px-3 py-2 md:p-4 border-b border-slate-100 flex justify-between items-center bg-white md:bg-white">
                        <div class="flex items-center gap-2 cursor-pointer md:cursor-default flex-1" onclick="toggleMobileCart()">
                            <h2 class="font-bold text-base md:text-lg text-emerald-800"><i class="fa-solid fa-list-ul mr-1 md:mr-2"></i>বিক্রি তালিকা</h2>
                            <i class="fa-solid fa-chevron-down md:hidden text-slate-400" id="mobile-cart-icon"></i>
                        </div>
                        <button onclick="clearCart(event)" class="text-xs md:text-sm text-red-500 hover:text-red-700 font-medium px-2 py-1 rounded hover:bg-red-50 transition shrink-0">মুছুন</button>
                    </div>

                    <!-- Cart Items (Scrollable) -->
                    <div id="cart-items" class="flex-1 overflow-y-auto p-2 md:p-3 space-y-2"></div>

                    <!-- Cart Footer -->
                    <div class="p-3 bg-white border-t border-slate-200 space-y-2 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] shrink-0">
                        <div class="flex justify-between items-center text-xs md:text-sm font-medium text-slate-600">
                            <span>মোট পণ্য:</span>
                            <span id="cart-count-badge" class="bg-slate-100 px-2 py-0.5 rounded-full">0 টি</span>
                        </div>
                        <div class="flex justify-between items-center text-xl md:text-2xl font-bold text-slate-800">
                            <span>মোট</span>
                            <span id="cart-total" class="text-emerald-600">৳ ০</span>
                        </div>
                        <button onclick="handleCheckout()" id="checkout-btn" disabled class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 md:py-4 rounded-xl shadow-lg shadow-emerald-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-95 text-base md:text-lg mt-2 leading-relaxed">
                            চালান তৈরি করুন
                        </button>
                    </div>
                </div>
            </div>

            <!-- ADMIN VIEW (Restricted to Admins) -->
            <div id="admin-view" class="hidden w-full h-full bg-slate-100 flex flex-col md:flex-row overflow-hidden">
                
                <!-- Sidebar -->
                <div class="w-full md:w-64 bg-slate-900 text-slate-300 flex flex-col shrink-0 h-auto md:h-full no-print z-10">
                    <div class="p-4 border-b border-slate-700"><p class="text-xs uppercase tracking-wider font-semibold text-slate-500">অ্যাডমিন প্যানেল</p><h3 class="text-white font-bold mt-1">ম্যানেজমেন্ট</h3></div>
                    
                    <!-- Navigation -->
                    <nav class="flex-1 overflow-y-auto py-4 space-y-1">
                        <button onclick="switchAdminTab('inventory')" class="admin-tab w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white transition-colors border-l-4 border-transparent active-tab"><i class="fa-solid fa-boxes-stacked w-6"></i> পণ্য তালিকা</button>
                        
                        <!-- Reports Tab (ID added to hide for workers) -->
                        <button id="nav-reports" onclick="switchAdminTab('reports')" class="admin-tab w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white transition-colors border-l-4 border-transparent"><i class="fa-solid fa-chart-line w-6"></i> বিক্রয় রিপোর্ট</button>
                        
                        <button id="nav-settings" onclick="switchAdminTab('settings')" class="admin-tab w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white transition-colors border-l-4 border-transparent"><i class="fa-solid fa-sliders w-6"></i> দোকানের সেটিংস</button>
                        
                        <!-- User Management Tab -->
                        <button id="nav-users" onclick="switchAdminTab('users')" class="admin-tab w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white transition-colors border-l-4 border-transparent"><i class="fa-solid fa-shield-halved w-6"></i> সিকিউরিটি ম্যানেজমেন্ট</button>
                    </nav>
                    
                    <div class="p-4 border-t border-slate-700 shrink-0">
                        <button onclick="exitAdminMode()" class="w-full flex items-center px-2 py-2 text-sm bg-slate-800 text-slate-300 hover:bg-slate-700 hover:text-white rounded transition">
                            <i class="fa-solid fa-arrow-left mr-2"></i> ফিরে যান
                        </button>
                    </div>
                </div>

                <!-- Admin Content -->
                <div class="flex-1 overflow-y-auto min-h-0 p-2 md:p-8">
                    
                    <!-- Tab: Inventory -->
                    <div id="tab-inventory" class="admin-content space-y-2 md:space-y-4">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 md:gap-3">
                            <h2 class="text-lg md:text-2xl font-bold text-slate-800 leading-relaxed">পণ্য ইনভেন্টরি</h2>
                            <button onclick="openProductModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition text-sm"><i class="fa-solid fa-plus mr-2"></i> নতুন পণ্য</button>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm text-slate-600 min-w-[600px]">
                                    <thead class="bg-slate-50 text-slate-700 uppercase font-semibold">
                                        <tr>
                                            <th class="px-4 py-3">পণ্যের নাম</th>
                                            <th class="px-4 py-3">কেনা দাম</th>
                                            <th class="px-4 py-3">বিক্রয় দাম</th>
                                            <th class="px-4 py-3">স্টক</th>
                                            <th class="px-4 py-3">অবস্থান</th>
                                            <th class="px-4 py-3 text-right">অ্যাকশন</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventory-table-body" class="divide-y divide-slate-100"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Reports -->
                    <div id="tab-reports" class="admin-content hidden space-y-4 md:space-y-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 no-print">
                            <h2 class="text-lg md:text-2xl font-bold text-slate-800 leading-relaxed">বিক্রয় রিপোর্ট</h2>
                            <button onclick="printSalesReport()" class="bg-slate-800 text-white px-4 py-2 rounded-lg shadow hover:bg-slate-900 transition flex items-center gap-2">
                                <i class="fa-solid fa-print"></i> রিপোর্ট প্রিন্ট
                            </button>
                        </div>
                        
                        <!-- Filters -->
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200 space-y-4 no-print">
                            <h3 class="font-bold text-lg text-slate-700 border-b pb-2">ফিল্টার করুন</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">নির্দিষ্ট তারিখ</label>
                                    <input type="date" id="report-date" oninput="generateReport('date')" onchange="generateReport('date')" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">নির্দিষ্ট মাস</label>
                                    <input type="month" id="report-month" oninput="generateReport('month')" onchange="generateReport('month')" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mt-2 gap-2">
                                <button onclick="clearReportFilters()" class="text-blue-600 text-sm hover:underline">ফিল্টার মুছে ফেলুন</button>
                                <button onclick="deleteHistoryBasedOnFilter()" class="text-red-600 text-sm font-medium hover:text-red-800 hover:underline flex items-center gap-1">
                                    <i class="fa-solid fa-trash-can"></i> ইতিহাস মুছে ফেলুন
                                </button>
                            </div>
                        </div>

                        <!-- Summary Cards -->
                        <div id="report-summary-cards" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="bg-blue-50 p-4 md:p-6 rounded-xl border border-blue-100"><p class="text-sm text-blue-600 mb-1">মোট বিক্রয়</p><p id="report-total-sales" class="text-xl md:text-2xl font-bold text-blue-800">৳ ০</p></div>
                            <div class="bg-orange-50 p-4 md:p-6 rounded-xl border border-orange-100"><p class="text-sm text-orange-600 mb-1">মোট খরচ</p><p id="report-total-cost" class="text-xl md:text-2xl font-bold text-orange-800">৳ ০</p></div>
                            <div class="bg-emerald-50 p-4 md:p-6 rounded-xl border border-emerald-100"><p class="text-sm text-emerald-600 mb-1">মোট লাভ</p><p id="report-profit" class="text-xl md:text-2xl font-bold text-emerald-800">৳ ০</p></div>
                        </div>

                        <!-- Detailed Sales Table -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="p-4 border-b border-slate-200 bg-slate-50 font-bold text-slate-700">বিক্রয়ের বিস্তারিত তালিকা</div>
                            <div class="overflow-x-auto max-h-80">
                                <table class="w-full text-left text-sm text-slate-600 min-w-[500px]">
                                    <thead class="bg-slate-100 text-slate-700 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-2">পণ্যের নাম</th>
                                            <th class="px-4 py-2 text-center">পরিমাণ</th>
                                            <th class="px-4 py-2 text-right">বিক্রয় মূল্য</th>
                                            <th class="px-4 py-2 text-right">সময়</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detailed-sales-body" class="divide-y divide-slate-100"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Settings -->
                    <div id="tab-settings" class="admin-content hidden space-y-4 md:space-y-6">
                        <h2 class="text-lg md:text-2xl font-bold text-slate-800 leading-relaxed">দোকানের সেটিংস</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Shop Info -->
                            <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="font-bold text-lg mb-4 text-emerald-700">দোকানের তথ্য</h3>
                                <form id="settings-form" onsubmit="saveSettings(event)" class="space-y-4">
                                    <div><label class="block text-sm font-medium text-slate-700 mb-1">দোকানের নাম</label><input type="text" id="setting-shop-name" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none"></div>
                                    <div><label class="block text-sm font-medium text-slate-700 mb-1">প্রোপাইটর / মালিক</label><input type="text" id="setting-proprietor" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none"></div>
                                    <div><label class="block text-sm font-medium text-slate-700 mb-1">মোবাইল নম্বর</label><input type="text" id="setting-mobile" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none"></div>
                                    <button type="submit" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 transition">সেভ করুন</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: User Management (Security Management) -->
                    <div id="tab-users" class="admin-content hidden space-y-6">
                        <div class="mb-4">
                            <h2 class="text-2xl font-bold text-slate-800 leading-relaxed">সিকিউরিটি ম্যানেজমেন্ট</h2>
                            <p class="text-slate-500 text-sm mt-1 leading-relaxed">এখান থেকে আপনি অ্যাডমিন এবং ওয়ার্কার পাসওয়ার্ড পরিবর্তন করতে পারবেন।</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Admin PIN Section -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 border-t-4 border-t-slate-700">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600">
                                        <i class="fa-solid fa-user-tie"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg text-slate-800">অ্যাডমিন পাসওয়ার্ড</h3>
                                        <p class="text-xs text-slate-500">পুরো সিস্টেমের কন্ট্রোল</p>
                                    </div>
                                </div>
                                <form onsubmit="updateAdminPin(event)" class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">বর্তমান অ্যাডমিন পাসওয়ার্ড</label>
                                        <input type="password" id="admin-current-pin" required class="w-full px-3 py-2 rounded border border-slate-300 focus:ring-2 focus:ring-slate-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">নতুন অ্যাডমিন পাসওয়ার্ড</label>
                                        <input type="password" id="admin-new-pin" required class="w-full px-3 py-2 rounded border border-slate-300 focus:ring-2 focus:ring-slate-500 outline-none">
                                    </div>
                                    <button type="submit" class="w-full bg-slate-700 text-white font-bold py-2 rounded hover:bg-slate-800 transition">
                                        আপডেট করুন
                                    </button>
                                </form>
                            </div>

                            <!-- Worker PIN Section -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 border-t-4 border-t-blue-500">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                                        <i class="fa-solid fa-user-check"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg text-slate-800">ওয়ার্কার পাসওয়ার্ড</h3>
                                        <p class="text-xs text-slate-500">বিক্রি করার জন্য ব্যবহৃত</p>
                                    </div>
                                </div>
                                <form onsubmit="updateWorkerPin(event)" class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">ওয়ার্কার পাসওয়ার্ড</label>
                                        <input type="text" id="worker-new-pin" required class="w-full px-3 py-2 rounded border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="যেমন: 1234">
                                    </div>
                                    <p class="text-xs text-slate-500 bg-blue-50 p-2 rounded leading-relaxed">ওয়ার্কাররা শুধুমাত্র বিক্রি করতে পারবে। রিপোর্ট দেখতে পারবে না।</p>
                                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 transition">
                                        আপডেট করুন
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- MOBILE FLOATING ACTION BUTTON (FAB) -->
    <button onclick="toggleMobileCart()" class="md:hidden fixed bottom-4 right-4 z-40 bg-emerald-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center transition-transform hover:scale-105 active:scale-95 border-4 border-white">
        <i class="fa-solid fa-cart-shopping text-xl"></i>
        <span id="fab-count" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-slate-100 opacity-0 transition-opacity transform scale-0">0</span>
    </button>

    <!-- MODALS -->
    
    <!-- Product Modal -->
    <div id="product-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm no-print">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-slate-800 leading-relaxed">পণ্য যুক্ত করুন</h3>
            <form id="product-form" onsubmit="handleProductSubmit(event)" class="space-y-3">
                <input type="hidden" id="prod-id">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">পণ্যের নাম</label><input type="text" id="prod-name" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none leading-relaxed"></div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">কেনা দাম</label><input type="number" step="0.01" id="prod-buy" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">বিক্রয় দাম</label><input type="number" step="0.01" id="prod-sell" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">স্টক পরিমাণ</label><input type="number" step="0.01" id="prod-stock" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">অবস্থান</label><input type="text" id="prod-loc" placeholder="যেমন: তাক ১" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></div>
                </div>

                <!-- Bulk System Toggle -->
                <div class="flex items-center justify-between bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <span class="text-sm font-bold text-blue-800">পাইকারি (বস্তা/কার্টুন) সিস্টেম?</span>
                    <input type="checkbox" id="bulk-toggle" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                </div>

                <!-- Bulk Inputs Container -->
                <div id="bulk-inputs-container" class="hidden space-y-3 pt-2 border-t border-slate-100">
                    <p class="text-xs text-slate-500 font-semibold">বাল্ক সেটিংস (যেমন: বস্তা, খাচি)</p>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1">খুচরা একক (Unit)</label>
                            <select id="prod-unit-name" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="কেজি">কেজি (KG)</option>
                                <option value="পিস">পিস (PC)</option>
                                <option value="লিটার">লিটার (Ltr)</option>
                                <option value="হালি">হালি (Hali)</option>
                                <option value="ডজন">ডজন (Doz)</option>
                                <option value="গ্রাম">গ্রাম (Gm)</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1">পাইকারি একক (Bulk)</label>
                            <select id="prod-bulk-name" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="বস্তা">বস্তা (Bosta)</option>
                                <option value="খাঁচি">খাঁচি (Khachi)</option>
                                <option value="কেস">কেস (Case)</option>
                                <option value="কার্টুন">কার্টুন (Cartoon)</option>
                                <option value="প্যাকেট">প্যাকেট (Packet)</option>
                                <option value="ডজন">ডজন (Doz)</option>
                                <option value="হালি">হালি (Hali)</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-[10px] font-bold text-slate-500 mb-1">পরিমাণ প্রতি বাল্ক</label><input type="number" id="prod-bulk-qty" placeholder="50" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
                        <div><label class="block text-[10px] font-bold text-slate-500 mb-1">বাল্ক বিক্রয় দাম</label><input type="number" id="prod-bulk-sell" placeholder="0.00" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
                    </div>
                </div>

                <!-- Mid System Toggle -->
                <div class="flex items-center justify-between bg-purple-50 p-3 rounded-lg border border-purple-100 mt-2">
                    <span class="text-sm font-bold text-purple-800">মাঝারি (হালি/ডজন) সিস্টেম?</span>
                    <input type="checkbox" id="mid-toggle" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500">
                </div>

                <!-- Mid Inputs Container -->
                <div id="mid-inputs-container" class="hidden space-y-3 pt-2 border-t border-slate-100">
                    <p class="text-xs text-slate-500 font-semibold">মাঝারি সেটিংস (যেমন: হালি, ডজন)</p>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="col-span-2 sm:col-span-1">
                            <label class="block text-[10px] font-bold text-slate-500 mb-1">মাঝারি একক (Mid)</label>
                            <select id="prod-mid-name" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-purple-500 outline-none">
                                <option value="হালি">হালি (Hali)</option>
                                <option value="ডজন">ডজন (Doz)</option>
                                <option value="কেস">কেস (Case)</option>
                                <option value="প্যাক">প্যাক (Pack)</option>
                                <option value="সেট">সেট (Set)</option>
                            </select>
                        </div>

                        <div><label class="block text-[10px] font-bold text-slate-500 mb-1">পরিমাণ প্রতি Mid</label><input type="number" id="prod-mid-qty" placeholder="12" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
                        <div><label class="block text-[10px] font-bold text-slate-500 mb-1">Mid বিক্রয় দাম</label><input type="number" id="prod-mid-sell" placeholder="0.00" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="closeModal('product-modal')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg border border-slate-300">বাতিল</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">সেভ করুন</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Memo Modal (Thermal Printer Friendly) -->
    <div id="memo-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm no-print">
        <div class="bg-white w-full max-w-[80mm] mx-auto h-[95vh] md:h-auto md:max-h-[90vh] rounded-t-2xl md:rounded-lg shadow-2xl flex flex-col overflow-hidden">
            <div class="bg-slate-100 p-3 border-b flex justify-between items-center shrink-0 no-print">
                <h3 class="font-bold text-slate-700">প্রিভিউ চালান</h3>
                <div class="flex gap-2">
                    <button onclick="printMemo()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700 flex items-center gap-1"><i class="fa-solid fa-print"></i> প্রিন্ট</button>
                    <button onclick="closeModal('memo-modal')" class="bg-red-500 text-white px-3 py-1.5 rounded text-sm hover:bg-red-600"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            
            <div id="memo-print-area" class="flex-1 overflow-y-auto p-4 bg-white text-black font-sans text-sm leading-relaxed">
                <div class="text-center mb-4 border-b-2 border-dashed border-slate-800 pb-4">
                    <h1 id="memo-shop-name" class="text-lg font-bold uppercase tracking-wide leading-tight mb-1">দোকানের নাম</h1>
                    <p id="memo-prop" class="text-xs">প্রোপাইটর: নাম</p>
                    <p id="memo-mobile" class="text-xs">মোবাইল: ০োকানের মোবাইল</p>
                    <p class="text-[10px] mt-2 font-bold" id="memo-date">Date: </p>
                    <p class="text-[10px]">Invoice #: <span id="memo-invoice">0000</span></p>
                </div>
                <table class="w-full text-xs mb-4 border-collapse">
                    <thead><tr class="border-b border-slate-800 font-bold"><td class="py-1 text-left w-1/2">বিবরণ</td><td class="py-1 text-center w-1/6">পরিমাণ</td><td class="py-1 text-right w-1/6">দাম</td><td class="py-1 text-right w-1/6">টাকা</td></tr></thead>
                    <tbody id="memo-items"></tbody>
                </table>
                <div class="border-t-2 border-dashed border-slate-800 pt-2">
                    <table class="w-full text-xs">
                        <tr><td class="text-left py-1 font-bold text-lg">সর্বমোট:</td><td class="text-right font-bold text-xl" id="memo-total">৳ ০</td></tr>
                    </table>
                </div>
                <div class="mt-6 pt-2 border-t border-dashed border-slate-300 text-center text-[10px]">
                    <p class="font-bold text-base mb-1">ধন্যবাদ, আবার আসবেন!</p>
                    <p class="text-slate-500">MRU</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PRINT CONTAINER FOR REPORTS -->
    <div id="report-print-container" class="hidden bg-white text-black p-4 font-sans max-w-[210mm] mx-auto leading-relaxed">
        <div class="text-center border-b-2 border-black pb-4 mb-6">
            <h1 id="print-rpt-shop-name" class="text-2xl font-bold uppercase tracking-wide mb-1"></h1>
            <p id="print-rpt-prop" class="text-sm font-semibold mb-1"></p>
            <p id="print-rpt-mobile" class="text-sm"></p>
        </div>
        <div class="mb-6 text-center font-bold text-lg">রিপোর্ট পিরিয়ড: <span id="print-rpt-period"></span></div>
        <div class="grid grid-cols-3 gap-2 mb-6 border border-black p-2 text-center">
            <div class="border-r border-black">
                <p class="text-[10px] font-bold uppercase">মোট বিক্রয়</p>
                <p id="print-rpt-total-sales" class="text-base font-bold mt-1"></p>
            </div>
            <div class="border-r border-black">
                <p class="text-[10px] font-bold uppercase">মোট খরচ</p>
                <p id="print-rpt-total-cost" class="text-base font-bold mt-1"></p>
            </div>
            <div>
                <p class="text-[10px] font-bold uppercase">মোট লাভ</p>
                <p id="print-rpt-profit" class="text-base font-bold mt-1"></p>
            </div>
        </div>
        <div class="mb-2 font-bold text-lg underline">বিক্রয়ের বিস্তারিত তালিকা</div>
        <table class="w-full text-xs border-collapse border border-black mb-6">
            <thead>
                <tr class="bg-slate-200 font-bold border-b border-black">
                    <th class="border border-black p-1 text-left">পণ্যের নাম</th>
                    <th class="border border-black p-1 text-center">পরিমাণ</th>
                    <th class="border border-black p-1 text-right">বিক্রয় মূল্য</th>
                    <th class="border border-black p-1 text-right">সময়</th>
                </tr>
            </thead>
            <tbody id="print-rpt-table-body"></tbody>
        </table>
        <div class="mt-8 pt-2 border-t border-black text-center text-xs">
            <p>প্রিন্ট তারিখ: <span id="print-timestamp"></span></p>
        </div>
    </div>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[60] flex flex-col items-center gap-2 pointer-events-none no-print w-full max-w-sm px-4"></div>

    <script>
        // ==========================================
        // INIT & LOAD
        // ==========================================
        async function init() {
            // FIX: "Login Screen to always appear first"
            // We force the login screen to be visible immediately.
            // We also clear the local storage to ensure a fresh login state on refresh, 
            // as per the requirement "whenever the page is opened or refreshed".
            // localStorage.removeItem('storeUser'); // Optional: strict reset
            showLoginScreen();

            // Fetch data in background so it's ready when they log in
            fetchData();
            
            // ==========================================
            // REAL-TIME SYNC IMPLEMENTATION (UPDATED)
            // ==========================================
            // Listen to changes in products and sales_history tables
            
            // 1. Product Sync (Existing Logic)
            _supabase.channel('public-db-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, (payload) => {
                    console.log('Products changed:', payload);
                    fetchData();
                })
                
                // 2. Sales History Sync (UPDATED LOGIC)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sales_history' }, async (payload) => {
                    console.log('Sales History changed:', payload);
                    
                    // 1. Refresh local state from DB
                    await fetchData();

                    // 2. Detect currently active filter to preserve user preference
                    const dateInput = document.getElementById('report-date');
                    const monthInput = document.getElementById('report-month');
                    
                    let currentFilter = 'all';
                    
                    // Check which filter is currently applied by reading input values
                    if (dateInput && dateInput.value) {
                        currentFilter = 'date';
                    } else if (monthInput && monthInput.value) {
                        currentFilter = 'month';
                    }

                    // 3. Trigger Report Update immediately
                    // We ensure the report tab exists before trying to update it (good practice)
                    if (document.getElementById('tab-reports')) {
                        generateReport(currentFilter);
                    }
                })
                .subscribe();

            document.getElementById('product-search').addEventListener('input', (e) => renderProducts(e.target.value));
            document.getElementById('bulk-toggle').addEventListener('change', (e) => {
                const div = document.getElementById('bulk-inputs-container');
                if(e.target.checked) div.classList.remove('hidden');
                else div.classList.add('hidden');
            });
            document.getElementById('mid-toggle').addEventListener('change', (e) => {
                const div = document.getElementById('mid-inputs-container');
                if(e.target.checked) div.classList.remove('hidden');
                else div.classList.add('hidden');
            });
        }

        // ==========================================
        // LOGIN / SESSION LOGIC
        // ==========================================
        let currentLoginView = 'worker';

        function showLoginScreen() {
            const loginScreen = document.getElementById('login-screen');
            loginScreen.classList.remove('hidden');
            // Default to Worker tab on show
            toggleLoginView('worker');
        }

        function toggleLoginView(view) {
            currentLoginView = view;
            const workerPanel = document.getElementById('worker-login-panel');
            const adminPanel = document.getElementById('admin-login-panel');
            const btnWorker = document.getElementById('btn-login-worker');
            const btnAdmin = document.getElementById('btn-login-admin');

            if (view === 'worker') {
                workerPanel.classList.remove('hidden');
                adminPanel.classList.add('hidden');
                
                // Update Worker Button Style (Emerald)
                btnWorker.classList.add('worker-active');
                btnWorker.classList.remove('admin-active');
                
                // Update Admin Button Style (Inactive)
                btnAdmin.classList.remove('admin-active');
                btnAdmin.classList.remove('worker-active');

            } else {
                adminPanel.classList.remove('hidden');
                workerPanel.classList.add('hidden');
                
                // Update Admin Button Style (Slate/Dark)
                btnAdmin.classList.add('admin-active');
                btnAdmin.classList.remove('worker-active');
                
                // Update Worker Button Style (Inactive)
                btnWorker.classList.remove('worker-active');
                btnWorker.classList.remove('admin-active');
            }
        }

        async function performLogin(role) {
            // Ensure data is loaded if not already
            if (state.products.length === 0) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('loading-screen').classList.remove('hidden');
                await fetchData();
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }

            let success = false;
            let pin = "";

            if (role === 'admin') {
                pin = document.getElementById('admin-login-pin').value;
                if (pin === state.settings.pin) {
                    state.currentUser = { role: 'admin', name: 'Administrator' };
                    success = true;
                } else {
                    showToast("ভুল অ্যাডমিন পাসওয়ার্ড!", "error");
                    document.getElementById('admin-login-pin').value = '';
                    return;
                }
            } else {
                pin = document.getElementById('worker-login-pin').value;
                if (pin === state.settings.worker_pin) {
                    state.currentUser = { role: 'worker', name: 'Worker' };
                    success = true;
                } else {
                    showToast("ভুল ওয়ার্কার পাসওয়ার্ড!", "error");
                    document.getElementById('worker-login-pin').value = '';
                    return;
                }
            }

            if (success) {
                localStorage.setItem('storeUser', JSON.stringify(state.currentUser));
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                setupUIForRole();
                showToast(`স্বাগতম, ${state.currentUser.role === 'admin' ? 'অ্যাডমিন' : 'ওয়ার্কার'}`, "success");
            }
        }

        function logout() {
            if(confirm("আপনি কি লগআউট করতে চান?")) {
                state.currentUser = null;
                state.cart = [];
                localStorage.removeItem('storeUser');
                location.reload();
            }
        }

        function setupUIForRole() {
            const role = state.currentUser?.role;
            const settingsBtn = document.getElementById('header-settings-btn');
            const workerView = document.getElementById('worker-view');
            const adminView = document.getElementById('admin-view');
            
            const navReports = document.getElementById('nav-reports');
            const navSettings = document.getElementById('nav-settings');
            const navUsers = document.getElementById('nav-users');

            document.getElementById('app').classList.remove('hidden');

            workerView.classList.remove('hidden');
            adminView.classList.add('hidden');

            // Render products and cart now that app is visible
            renderProducts();
            renderCart();
            updateSettingsUI();

            if (role === 'admin') {
                settingsBtn.classList.remove('hidden');
                navReports.classList.remove('hidden');
                navSettings.classList.remove('hidden');
                navUsers.classList.remove('hidden');

            } else if (role === 'worker') {
                settingsBtn.classList.add('hidden');
                navReports.classList.add('hidden');
                navSettings.classList.add('hidden');
                navUsers.classList.add('hidden');
                adminView.classList.add('hidden');
            }
        }
        
        // ==========================================
        // MASTER CODE LOGIC (Enhanced UI Feedback)
        // ==========================================
        function openMasterCodeModal() {
            const modal = document.getElementById('master-code-modal');
            const content = document.getElementById('master-code-content');
            const input = document.getElementById('master-code-input');
            const resultDiv = document.getElementById('master-code-result');

            modal.classList.remove('hidden');
            // Animation trigger
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            setTimeout(() => content.classList.remove('scale-95'), 10);
            
            input.value = '';
            resultDiv.classList.add('hidden');
            resultDiv.className = "mb-6 text-sm hidden rounded-xl overflow-hidden shadow-sm border break-words leading-relaxed"; // Reset classes
            
            // Optional: Focus on input
            setTimeout(() => input.focus(), 100);
        }

        function closeMasterCodeModal() {
            const modal = document.getElementById('master-code-modal');
            const content = document.getElementById('master-code-content');
            
            modal.classList.add('opacity-0');
            content.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function checkMasterCode() {
            const inputCode = document.getElementById('master-code-input').value;
            const resultDiv = document.getElementById('master-code-result');
            resultDiv.classList.remove('hidden');

            // Security: Check against CONFIG, not hardcoded in HTML
            if (inputCode === CONFIG.MASTER_RESET_CODE) {
                // Show Success (Beautiful Green Box)
                resultDiv.className = "mb-6 p-6 rounded-xl border border-green-200 bg-green-50 text-green-800 text-center animate-fade-in shadow-sm leading-relaxed";
                resultDiv.innerHTML = `
                    <div class="flex flex-col items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-3">
                            <i class="fa-solid fa-check text-2xl text-green-600"></i>
                        </div>
                        <p class="font-bold text-lg">সফল! আপনার পাসওয়ার্ড:</p>
                        <div class="mt-3 px-4 py-2 bg-white border border-green-200 rounded-lg shadow-sm">
                            <span class="text-3xl font-bold tracking-widest text-green-900 select-all">${state.settings.pin}</span>
                        </div>
                    </div>
                `;
            } else {
                // Show Error (Red Box)
                resultDiv.className = "mb-6 p-4 rounded-xl border border-red-200 bg-red-50 text-red-800 text-center animate-fade-in shadow-sm leading-relaxed";
                resultDiv.innerHTML = `
                    <div class="flex items-center justify-center gap-2 font-bold text-red-700 mb-1">
                        <i class="fa-solid fa-circle-xmark text-xl"></i> ভুল মাস্টার কোড!
                    </div>
                    <p class="text-sm opacity-90 text-red-600">দয়া করে সঠিক কোড দিয়ে আবার চেষ্টা করুন।</p>
                `;
            }
        }
        
        // ==========================================
        // REPORT LOGIC
        // ==========================================
        let currentFilteredSales = [];

        function generateReport(filterType) {
            const dateInput = document.getElementById('report-date').value;
            const monthInput = document.getElementById('report-month').value;
            currentFilteredSales = state.salesHistory;

            if (filterType === 'date' && dateInput) {
                currentFilteredSales = state.salesHistory.filter(s => s.date.startsWith(dateInput));
                document.getElementById('report-month').value = "";
            } else if (filterType === 'month' && monthInput) {
                currentFilteredSales = state.salesHistory.filter(s => s.date.startsWith(monthInput));
                document.getElementById('report-date').value = "";
            }
            renderReportData(currentFilteredSales);
        }

        function renderReportData(sales) {
            const totalSales = sales.reduce((sum, s) => sum + (s.totalSell || 0), 0);
            const totalCost = sales.reduce((sum, s) => sum + (s.totalCost || 0), 0);
            const profit = totalSales - totalCost;

            document.getElementById('report-total-sales').innerText = `৳ ${totalSales.toLocaleString()}`;
            document.getElementById('report-total-cost').innerText = `৳ ${totalCost.toLocaleString()}`;
            document.getElementById('report-profit').innerText = `৳ ${profit.toLocaleString()}`;

            const tbody = document.getElementById('detailed-sales-body');
            tbody.innerHTML = "";
            if(sales.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-slate-400">কোন বিক্রয় পাওয়া যায়নি</td></tr>`;
                return;
            }
            sales.forEach(sale => {
                sale.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-slate-50";
                    const timeStr = new Date(item.time).toLocaleTimeString('bn-BD', {hour: '2-digit', minute:'2-digit', useGrouping: false});
                    row.innerHTML = `<td class="px-4 py-2">${item.name}</td><td class="px-4 py-2 text-center">${item.qty} ${item.unit || ''}</td><td class="px-4 py-2 text-right">৳ ${(item.price * item.qty).toLocaleString()}</td><td class="px-4 py-2 text-right text-xs text-slate-500">${timeStr}</td>`;
                    tbody.appendChild(row);
                });
            });
        }

        function clearReportFilters() {
            document.getElementById('report-date').value = "";
            document.getElementById('report-month').value = "";
            generateReport('all');
        }

        async function deleteHistoryBasedOnFilter() {
            const dateInput = document.getElementById('report-date').value;
            const monthInput = document.getElementById('report-month').value;

            if (!dateInput && !monthInput) {
                showToast("ডাটা মুছে ফেলার জন্য প্রথমে একটি তারিখ বা মাস সিলেক্ট করুন।", "error");
                return;
            }

            let confirmMsg = "আপনি কি নিশ্চিত যে এই তারিখের সকল ডাটা মুছে ফেলতে চান?";
            if (dateInput) confirmMsg += `\n(নির্দিষ্ট তারিখ: ${dateInput})`;
            else if (monthInput) confirmMsg += `\n(নির্দিষ্ট মাস: ${monthInput})`;

            if (confirm(confirmMsg)) {
                let query = _supabase.from('sales_history');
                
                if (dateInput) {
                    query = query.filter('date', 'cs', `^${dateInput}`);
                } else if (monthInput) {
                    query = query.filter('date', 'cs', `^${monthInput}`);
                }

                const { error } = await query.delete();

                if (error) {
                    showToast("ডিলিট করতে সমস্যা হয়েছে", "error");
                    console.error(error);
                } else {
                    await fetchData();
                    document.getElementById('report-date').value = "";
                    document.getElementById('report-month').value = "";
                    generateReport('all');
                    showToast("নির্দিষ্ট ইতিহাস মুছে ফেলা হয়েছে", "success");
                }
            }
        }

        // ==========================================
        // PRINT FUNCTIONS
        // ==========================================
        function printSalesReport() {
            document.body.classList.add('printing-report');
            document.body.classList.remove('printing-memo');
            document.getElementById('print-rpt-shop-name').innerText = state.settings.shopName;
            document.getElementById('print-rpt-prop').innerText = `প্রোপাইটর: ${state.settings.proprietor}`;
            document.getElementById('print-rpt-mobile').innerText = `মোবাইল: ${state.settings.mobile}`;
            const dateVal = document.getElementById('report-date').value;
            const monthVal = document.getElementById('report-month').value;
            let tempFilteredSales = state.salesHistory;
            if (dateVal) tempFilteredSales = state.salesHistory.filter(s => s.date.startsWith(dateVal));
            else if (monthVal) tempFilteredSales = state.salesHistory.filter(s => s.date.startsWith(monthVal));
            const totalSales = tempFilteredSales.reduce((sum, s) => sum + (s.totalSell || 0), 0);
            const totalCost = tempFilteredSales.reduce((sum, s) => sum + (s.totalCost || 0), 0);
            const profit = totalSales - totalCost;
            document.getElementById('print-rpt-total-sales').innerText = `৳ ${totalSales.toLocaleString()}`;
            document.getElementById('print-rpt-total-cost').innerText = `৳ ${totalCost.toLocaleString()}`;
            document.getElementById('print-rpt-profit').innerText = `৳ ${profit.toLocaleString()}`;
            let periodText = "সকল সময়ের রিপোর্ট";
            if (monthVal) {
                const bnMonths = ["জানুয়ারি", "ফেব্রুয়ারি", "মার্চ", "এপ্রিল", "মে", "জুন", "জুলাই", "আগস্ট", "সেপ্টেম্বর", "অক্টোবর", "নভেম্বর", "ডিসেম্বর"];
                const [year, monthIndex] = monthVal.split('-');
                periodText = `মাস: ${bnMonths[parseInt(monthIndex) - 1]} ${parseInt(year).toLocaleString('bn-BD', {useGrouping: false})}`;
            } else if (dateVal) {
                periodText = `তারিখ: ${new Date(dateVal).toLocaleDateString('bn-BD', {useGrouping: false})}`;
            }
            document.getElementById('print-rpt-period').innerText = periodText;
            const printTableBody = document.getElementById('print-rpt-table-body');
            printTableBody.innerHTML = "";
            if(tempFilteredSales.length === 0) {
                printTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-2">কোন তথ্য নেই</td></tr>`;
            } else {
                tempFilteredSales.forEach(sale => {
                    sale.items.forEach(item => {
                        const timeStr = new Date(item.time).toLocaleTimeString('bn-BD', {hour: '2-digit', minute:'2-digit', useGrouping: false});
                        const row = `<tr><td class="border border-black p-1 text-left">${item.name}</td><td class="border border-black p-1 text-center">${item.qty} ${item.unit || ''}</td><td class="border border-black p-1 text-right">৳ ${(item.price * item.qty).toLocaleString()}</td><td class="border border-black p-1 text-right">${timeStr}</td></tr>`;
                        printTableBody.innerHTML += row;
                    });
                });
            }
            document.getElementById('print-timestamp').innerText = new Date().toLocaleString('bn-BD', {useGrouping: false});
            window.print();
            setTimeout(() => { document.body.classList.remove('printing-report'); }, 1000);
        }

        function printMemo() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('bn-BD', {useGrouping: false});
            const timeStr = now.toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit', useGrouping: false });
            const memoDateEl = document.getElementById('memo-date');
            if(memoDateEl) memoDateEl.innerText = `তারিখ: ${dateStr} ${timeStr}`;
            document.body.classList.add('printing-memo');
            document.body.classList.remove('printing-report');
            window.print();
            setTimeout(() => { document.body.classList.remove('printing-memo'); }, 1000);
        }
        
        // ==========================================
        // HELPER: Format Stock (3 TIER LOGIC)
        // ==========================================
        function getStockDisplay(product) {
            let text = "";
            let remainder = product.stock;

            if (product.isBulk && product.bulkQty > 0) {
                const count = Math.floor(remainder / product.bulkQty);
                if (count > 0) text += `${count} ${product.bulkName} `;
                remainder = remainder % product.bulkQty;
            }

            if (product.isMid && product.midQty > 0) {
                const count = Math.floor(remainder / product.midQty);
                if (count > 0) text += `${count} ${product.midName} `;
                remainder = remainder % product.midQty;
            }

            if (remainder > 0 || text === "") {
                text += `${remainder} ${product.unitName || 'Unit'}`;
            }
            
            return text.trim();
        }

        // ==========================================
        // CART & PRODUCT LOGIC
        // ==========================================
        
        function goHome() {
            if(state.currentUser?.role === 'worker') return; 
            if(state.view === 'admin') switchView('worker');
        }

        function switchView(viewName) {
            state.view = viewName;
            const workerView = document.getElementById('worker-view');
            const adminView = document.getElementById('admin-view');
            
            if (viewName === 'admin') {
                if (state.currentUser?.role !== 'admin') {
                    showToast("প্রবেশাধিকার নেই!", "error");
                    return;
                }
                workerView.classList.add('hidden');
                adminView.classList.remove('hidden');
                renderInventory();
                generateReport('all');
            } else {
                adminView.classList.add('hidden');
                workerView.classList.remove('hidden');
            }
        }

        function renderProducts(filter = "") {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = "";
            const searchFilter = filter.toLowerCase();
            const filtered = state.products.filter(p => p.name.toLowerCase().includes(searchFilter));
            filtered.forEach(p => {
                const isOutOfStock = p.stock <= 0;
                const stockText = getStockDisplay(p);
                
                const card = document.createElement('div');
                card.className = `bg-white rounded-lg shadow-sm border ${isOutOfStock ? 'border-red-200 bg-red-50' : 'border-slate-200'} p-2 flex flex-col justify-between hover:shadow-md transition-shadow h-full`;
                
                let buttonsHtml = '';
                const unitLabel = p.unitName || 'Unit';
                
                let gridClass = "grid-cols-2";
                let textSize = "text-[10px] md:text-xs";

                if (p.isMid && p.isBulk) {
                    gridClass = "grid-cols-3 gap-1";
                    textSize = "text-[9px] md:text-[10px]";
                    buttonsHtml = `
                        <div class="grid ${gridClass} mt-2">
                            <button onclick="addToCart(${p.id}, 'unit')" ${isOutOfStock ? 'disabled' : ''} class="py-2 rounded font-medium ${textSize} transition-all border ${isOutOfStock ? 'border-red-200 text-red-400 cursor-not-allowed bg-red-50' : 'border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white active:scale-95 bg-white'}">
                                +1 ${unitLabel}
                            </button>
                            <button onclick="addToCart(${p.id}, 'mid')" ${isOutOfStock ? 'disabled' : ''} class="py-2 rounded font-medium ${textSize} transition-all border ${isOutOfStock ? 'border-red-200 text-red-400 cursor-not-allowed bg-red-50' : 'border-purple-600 text-purple-600 hover:bg-purple-600 hover:text-white active:scale-95 bg-white'}">
                                +1 ${p.midName || 'Mid'}
                            </button>
                            <button onclick="addToCart(${p.id}, 'bulk')" ${isOutOfStock ? 'disabled' : ''} class="py-2 rounded font-medium ${textSize} transition-all border ${isOutOfStock ? 'border-red-200 text-red-400 cursor-not-allowed bg-red-50' : 'border-emerald-600 text-emerald-600 hover:bg-emerald-600 hover:text-white active:scale-95 bg-white'}">
                                +1 ${p.bulkName || 'Bulk'}
                            </button>
                        </div>
                    `;
                } else if (p.isMid) {
                    buttonsHtml = `
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <button onclick="addToCart(${p.id}, 'unit')" ${isOutOfStock ? 'disabled' : ''} class="py-1.5 rounded-lg font-medium text-[10px] md:text-xs transition-all border ${isOutOfStock ? 'border-red-200 text-red-400 cursor-not-allowed bg-red-50' : 'border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white active:scale-95 bg-white'}">
                                +1 ${unitLabel}
                            </button>
                            <button onclick="addToCart(${p.id}, 'mid')" ${isOutOfStock ? 'disabled' : ''} class="py-1.5 rounded-lg font-medium text-[10px] md:text-xs transition-all border ${isOutOfStock ? 'border-red-200 text-red-400 cursor-not-allowed bg-red-50' : 'border-purple-600 text-purple-600 hover:bg-purple-600 hover:text-white active:scale-95 bg-white'}">
                                +1 ${p.midName || 'Mid'}
                            </button>
                        </div>
                    `;
                } else if (p.isBulk) {
                    buttonsHtml = `
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <button onclick="addToCart(${p.id}, 'unit')" ${isOutOfStock ? 'disabled' : ''} class="py-1.5 rounded-lg font-medium text-[10px] md:text-xs transition-all border ${isOutOfStock ? 'border-red-200 text-red-400 cursor-not-allowed bg-red-50' : 'border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white active:scale-95 bg-white'}">
                                +1 ${unitLabel}
                            </button>
                            <button onclick="addToCart(${p.id}, 'bulk')" ${isOutOfStock ? 'disabled' : ''} class="py-1.5 rounded-lg font-medium text-[10px] md:text-xs transition-all border ${isOutOfStock ? 'border-red-200 text-red-400 cursor-not-allowed bg-red-50' : 'border-emerald-600 text-emerald-600 hover:bg-emerald-600 hover:text-white active:scale-95 bg-white'}">
                                +1 ${p.bulkName || 'Bulk'}
                            </button>
                        </div>
                    `;
                } else {
                    buttonsHtml = `
                        <button onclick="addToCart(${p.id}, 'unit')" ${isOutOfStock ? 'disabled' : ''} class="mt-2 w-full py-1.5 rounded-lg font-medium text-xs transition-all border ${isOutOfStock ? 'border-red-200 text-red-400 cursor-not-allowed' : 'border-emerald-600 text-emerald-600 hover:bg-emerald-600 hover:text-white active:scale-95'}">
                            ${isOutOfStock ? 'স্টক নেই' : 'কার্টে যোগ'}
                        </button>
                    `;
                }

                card.innerHTML = `
                    <div class="mb-1">
                        <h3 class="font-bold text-slate-800 leading-tight text-sm line-clamp-2">${p.name}</h3>
                        <p class="text-[10px] text-slate-500 mt-1">${p.location}</p>
                    </div>
                    <div class="flex items-center justify-between mt-auto">
                        <span class="font-bold text-emerald-600 text-base">৳ ${p.sellPrice}</span>
                        <span class="text-[10px] px-1.5 py-0.5 rounded-full ${isOutOfStock ? 'bg-red-200 text-red-700' : 'bg-slate-100 text-slate-600'}">স্টক: ${stockText}</span>
                    </div>
                    ${buttonsHtml}`;
                grid.appendChild(card);
            });
        }

        function addToCart(id, mode = 'unit') {
            const product = state.products.find(p => p.id === id);
            if (!product) return;

            let stockDeduction = 1;
            let price = product.sellPrice;
            let unitLabel = product.unitName || 'Unit';

            if (mode === 'mid') {
                if (!product.isMid || !product.midQty) {
                    showToast("এই পণ্যটির জন্য মিড সেটিংস নেই!", "error");
                    return;
                }
                stockDeduction = product.midQty;
                price = product.midSellPrice;
                unitLabel = product.midName;
            } else if (mode === 'bulk') {
                if (!product.isBulk || !product.bulkQty) {
                    showToast("এই পণ্যটির জন্য বাল্ক সেটিংস নেই!", "error");
                    return;
                }
                stockDeduction = product.bulkQty;
                price = product.bulkSellPrice;
                unitLabel = product.bulkName;
            }

            const existingItem = state.cart.find(c => c.id === id && c.mode === mode);
            const currentQtyInCart = existingItem ? existingItem.qty : 0;
            const totalStockNeeded = (currentQtyInCart + 1) * stockDeduction;

            if (totalStockNeeded > product.stock) {
                showToast("পর্যাপ্ত স্টক নেই!", "error");
                return;
            }

            if (existingItem) {
                existingItem.qty++;
            } else {
                state.cart.push({ 
                    id, 
                    qty: 1, 
                    mode,
                    unitLabel, 
                    price,    
                    stockDeduction 
                });
            }
            renderCart();
            showToast("তালিকায় যোগ হয়েছে", "success");
        }

        // ==========================================
        // CART RENDERING
        // ==========================================
        function renderCart() {
            const container = document.getElementById('cart-items');
            const totalEl = document.getElementById('cart-total');
            const countEl = document.getElementById('cart-count-badge');
            const fabCountEl = document.getElementById('fab-count');
            const checkoutBtn = document.getElementById('checkout-btn');
            container.innerHTML = "";
            let totalSell = 0; 
            let totalItems = 0;
            
            if (state.cart.length === 0) {
                container.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-400"><i class="fa-solid fa-basket-shopping text-3xl opacity-30 mb-2"></i><p class="text-sm">তালিকা খালি</p></div>`;
                checkoutBtn.disabled = true; 
                checkoutBtn.classList.add('opacity-50');
                fabCountEl.classList.add('opacity-0', 'scale-0');
            } else {
                checkoutBtn.disabled = false; 
                checkoutBtn.classList.remove('opacity-50');
                state.cart.forEach(item => {
                    const product = state.products.find(p => p.id === item.id);
                    totalSell += item.price * item.qty; 
                    totalItems += item.qty;
                    
                    const div = document.createElement('div');
                    div.className = "flex flex-col sm:flex-row items-start sm:items-center justify-between bg-slate-50 p-2 rounded border border-slate-100 gap-2";
                    
                    const displayName = `${product.name} <span class="text-blue-600 font-medium text-xs">(${item.unitLabel})</span>`;

                    const inputHtml = `
                        <div class="flex items-center gap-1 w-full sm:w-auto justify-between sm:justify-start bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                            <button onclick="updateQty(${item.id}, '${item.mode}', -1)" class="w-9 h-9 rounded bg-slate-100 hover:bg-red-50 hover:text-red-500 text-slate-600 flex items-center justify-center text-lg font-bold transition-colors">-</button>
                            <input type="number" 
                                value="${item.qty}" 
                                min="1" 
                                class="w-10 md:w-14 h-8 text-center font-bold text-base bg-transparent focus:outline-none" 
                                oninput="handleQtyInput(${item.id}, '${item.mode}', this)" 
                                onblur="handleQtyBlur(${item.id}, '${item.mode}', this)"
                            >
                            <button onclick="updateQty(${item.id}, '${item.mode}', 1)" class="w-9 h-9 rounded bg-slate-100 hover:bg-emerald-50 hover:text-emerald-600 text-slate-600 flex items-center justify-center text-lg font-bold transition-colors">+</button>
                        </div>
                    `;

                    div.innerHTML = `<div class="flex-1 min-w-0 pr-2"><p class="font-bold text-sm text-slate-800 truncate leading-tight">${displayName}</p><p class="text-xs text-emerald-600 mt-0.5">৳ ${item.price} x ${item.qty}</p></div>${inputHtml}`;
                    container.appendChild(div);
                });
                
                fabCountEl.classList.remove('opacity-0', 'scale-0');
                fabCountEl.innerText = totalItems > 9 ? '9+' : totalItems;
            }
            totalEl.innerText = `৳ ${totalSell.toLocaleString()}`; 
            countEl.innerText = `${totalItems} টি`;
        }

        function updateQty(id, mode, change) {
            const item = state.cart.find(c => c.id === id && c.mode === mode);
            const product = state.products.find(p => p.id === id);
            if (!item) return;

            const newStockUsage = (item.qty + change) * item.stockDeduction;

            if (newStockUsage > product.stock) {
                showToast("ম্যাক্স স্টক অতিক্রম করতে পারবেন না", "error");
                return;
            }

            item.qty += change;
            if (item.qty <= 0) state.cart = state.cart.filter(c => c.id !== id || c.mode !== mode);
            renderCart();
        }

        function handleQtyInput(id, mode, inputEl) {
            const item = state.cart.find(c => c.id === id && c.mode === mode);
            const val = parseInt(inputEl.value);
            if (!item) return;
            if (!isNaN(val) && val > 0) {
                item.qty = val;
                updateCartTotals();
            }
        }

        function handleQtyBlur(id, mode, inputEl) {
            const item = state.cart.find(c => c.id === id && c.mode === mode);
            const product = state.products.find(p => p.id === id);
            let val = parseInt(inputEl.value);

            if (!item || !product) return;

            if (isNaN(val) || val <= 0) {
                if (val === 0) {
                    if (confirm("পরিমাণ ০ির করা হয়েছে। আইটেমটি তালিকা থেকে সরাতে চান?")) {
                        state.cart = state.cart.filter(c => !(c.id === id && c.mode === mode));
                    } else {
                        renderCart();
                        return;
                    }
                } else {
                    item.qty = 1;
                }
            } else {
                const stockUsage = val * item.stockDeduction;
                if (stockUsage > product.stock) {
                    showToast(`সর্বোচ্চ স্টক অতিক্রম করা হয়েছে`, "error");
                    const maxQty = Math.floor(product.stock / item.stockDeduction);
                    item.qty = maxQty > 0 ? maxQty : 1;
                } else {
                    item.qty = val;
                }
            }
            renderCart();
        }

        function updateCartTotals() {
            let total = 0;
            let count = 0;
            state.cart.forEach(item => {
                total += item.price * item.qty;
                count += item.qty;
            });
            document.getElementById('cart-total').innerText = `৳ ${total.toLocaleString()}`;
            document.getElementById('cart-count-badge').innerText = `${count} টি`;
        }

        function clearCart(e) { if(e) e.stopPropagation(); if(confirm("সমস্ত তালিকা মুছে ফেলতে চান?")) { state.cart = []; renderCart(); } }

        // ==========================================
        // ATOMIC STOCK DECREMENT & CHECKOUT
        // ==========================================
        async function handleCheckout() {
            if (state.cart.length === 0) return;
            
            let totalSell = 0, totalCost = 0;
            const memoItems = [], historyItems = [];

            // Calculate totals locally for the Sales History record
            [...state.cart].forEach(item => {
                const product = state.products.find(p => p.id === item.id);
                const itemSell = item.price * item.qty; 
                totalSell += itemSell;

                const unitsDeducted = item.qty * item.stockDeduction;
                const itemCost = product.buyPrice * unitsDeducted;
                totalCost += itemCost;
                
                historyItems.push({ 
                    name: product.name, 
                    qty: item.qty, 
                    unit: item.unitLabel, 
                    price: item.price, 
                    time: new Date().toISOString() 
                });

                memoItems.push({ 
                    name: `${product.name} (${item.unitLabel})`, 
                    qty: item.qty, 
                    rate: item.price, 
                    total: itemSell 
                });
            });
            
            const profit = totalSell - totalCost;

            try {
                // 1. ATOMIC STOCK DECREMENT
                // Loop through cart items and call the decrement_stock RPC function.
                // We map the cart items to an array of RPC promises.
                const stockUpdatePromises = state.cart.map(item => {
                    const unitsDeducted = item.qty * item.stockDeduction;
                    return _supabase.rpc('decrement_stock', { 
                        product_id: item.id, 
                        quantity: unitsDeducted 
                    });
                });

                // 2. CONCURRENCY SAFETY
                // Wait for all stock updates to finish successfully before proceeding.
                // If any product fails (e.g., race condition / insufficient stock in DB),
                // Promise.all will throw an error, and we won't record the sale.
                await Promise.all(stockUpdatePromises);

                // 3. RECORD THE SALE
                // Only record sales history after we are certain stock was decremented.
                const { error: salesError } = await _supabase
                    .from('sales_history')
                    .insert([{
                        date: new Date().toISOString(),
                        items: historyItems,
                        totalSell,
                        totalCost,
                        profit
                    }]);

                if (salesError) throw salesError;

                // 4. UPDATE LOCAL STATE
                // Update local state immediately for UI responsiveness.
                // (Realtime will also sync this eventually, but this makes it instant for the current user).
                state.cart.forEach(item => {
                    const p = state.products.find(prod => prod.id === item.id);
                    if(p) p.stock -= (item.qty * item.stockDeduction);
                });

                state.salesHistory.unshift({ 
                    id: Date.now(), 
                    date: new Date().toISOString(),
                    items: historyItems,
                    totalSell, totalCost, profit
                });

                // 5. CLEAR CART & SHOW MEMO
                showMemo(memoItems, totalSell);
                state.cart = []; 
                renderCart(); 
                renderProducts();
                showToast("বিক্রয় সফল হয়েছে", "success");

            } catch (err) {
                console.error("Checkout Error:", err);
                showToast("বিক্রয় সম্পন্ন করতে সমস্যা হয়েছে! (সম্ভবত স্টক শেষ)", "error");
            }
        }

        function showMemo(items, total) {
            const modal = document.getElementById('memo-modal');
            const list = document.getElementById('memo-items');
            document.getElementById('memo-shop-name').innerText = state.settings.shopName;
            document.getElementById('memo-prop').innerText = `প্রোপাইটর: ${state.settings.proprietor}`;
            document.getElementById('memo-mobile').innerText = `মোবাইল: ${state.settings.mobile}`;
            const now = new Date();
            document.getElementById('memo-date').innerText = `তারিখ: ${now.toLocaleDateString('bn-BD', {useGrouping: false})} ${now.toLocaleTimeString('bn-BD', {hour: '2-digit', minute:'2-digit', useGrouping: false})}`;
            document.getElementById('memo-invoice').innerText = Math.floor(Math.random() * 9000) + 1000;
            document.getElementById('memo-total').innerText = `৳ ${total.toLocaleString()}`;
            list.innerHTML = items.map(item => `<tr class="border-b border-dashed border-slate-300"><td class="py-1 pl-1 align-top leading-tight">${item.name}</td><td class="py-1 text-center align-top">${item.qty}</td><td class="py-1 text-right align-top">${item.rate}</td><td class="py-1 pr-1 text-right align-top font-medium">${item.total}</td></tr>`).join('');
            modal.classList.remove('hidden');
        }

        function toggleAdminAuth() {
            if (state.currentUser?.role !== 'admin') {
                showToast("অ্যাডমিন প্রয়োজন", "error");
                return;
            }
            switchView('admin');
        }

        function exitAdminMode() { 
            switchView('worker'); 
        }
        
        // ==========================================
        // USER MANAGEMENT LOGIC (PIN UPDATES)
        // ==========================================
        
        async function updateAdminPin(e) {
            e.preventDefault();
            const currentPin = document.getElementById('admin-current-pin').value;
            const newPin = document.getElementById('admin-new-pin').value;
            
            if(currentPin !== state.settings.pin) return showToast("বর্তমান পাসওয়ার্ড ভুল!", "error");
            if(newPin.length < 4) return showToast("পাসওয়ার্ড কমপক্ষে ৪ ডিজিট হতে হবে", "error");
            
            state.settings.pin = newPin;
            
            const { data, error } = await _supabase
                .from('settings')
                .update({ pin: newPin })
                .eq('id', state.settings.id)
                .select();
            
            if(error) {
                console.error(error);
                showToast("অ্যাডমিন পাসওয়ার্ড পরিবর্তনে সমস্যা হয়েছে", "error");
            } else {
                showToast("সফলভাবে পরিবর্তন হয়েছে!", "success");
                e.target.reset();
            }
        }

        async function updateWorkerPin(e) {
            e.preventDefault();
            const newPin = document.getElementById('worker-new-pin').value;
            
            if(newPin.length < 4) return showToast("পাসওয়ার্ড কমপক্ষে ৪ ডিজিট হতে হবে", "error");
            
            state.settings.worker_pin = newPin;

            const { data, error } = await _supabase
                .from('settings')
                .update({ worker_pin: newPin })
                .eq('id', state.settings.id)
                .select();
            
            if(error) {
                console.error(error);
                showToast("ওয়ার্কার পাসওয়ার্ড পরিবর্তনে সমস্যা হয়েছে", "error");
            } else {
                showToast("সফলভাবে পরিবর্তন হয়েছে!", "success");
                document.getElementById('worker-new-pin').value = newPin;
            }
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.admin-tab').forEach(el => { el.classList.remove('bg-slate-800', 'text-white', 'border-emerald-500'); el.classList.add('border-transparent'); });
            const btn = Array.from(document.querySelectorAll('.admin-tab')).find(b => b.onclick.toString().includes(tab));
            if(btn) { btn.classList.add('bg-slate-800', 'text-white', 'border-emerald-500'); btn.classList.remove('border-transparent'); }
        }

        function renderInventory() {
            const tbody = document.getElementById('inventory-table-body'); 
            tbody.innerHTML = "";
            state.products.forEach(p => {
                const stockText = getStockDisplay(p);
                const tr = document.createElement('tr'); tr.className = "border-b hover:bg-slate-50";
                tr.innerHTML = `<td class="px-4 py-3 font-medium whitespace-nowrap">${p.name}</td><td class="px-4 py-3">৳ ${p.buyPrice}</td><td class="px-4 py-3 text-emerald-600 font-bold">৳ ${p.sellPrice}</td><td class="px-4 py-3">${stockText}</td><td class="px-4 py-3 text-sm text-slate-500">${p.location}</td><td class="px-4 py-3 text-right"><button onclick="editProduct(${p.id})" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fa-solid fa-pen"></i></button><button onclick="deleteProduct(${p.id})" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }

        function openProductModal(id = null) {
            const modal = document.getElementById('product-modal'); 
            const form = document.getElementById('product-form'); 
            form.reset();
            
            document.getElementById('bulk-inputs-container').classList.add('hidden');
            document.getElementById('bulk-toggle').checked = false;
            document.getElementById('mid-inputs-container').classList.add('hidden');
            document.getElementById('mid-toggle').checked = false;

            if (id) {
                const p = state.products.find(x => x.id === id);
                document.getElementById('prod-id').value = p.id; 
                document.getElementById('prod-name').value = p.name; 
                document.getElementById('prod-buy').value = p.buyPrice; 
                document.getElementById('prod-sell').value = p.sellPrice; 
                document.getElementById('prod-stock').value = p.stock; 
                document.getElementById('prod-loc').value = p.location; 
                document.getElementById('modal-title').innerText = "পণ্য এডিট করুন";

                if (p.isBulk) {
                    document.getElementById('bulk-toggle').checked = true;
                    document.getElementById('bulk-inputs-container').classList.remove('hidden');
                    document.getElementById('prod-unit-name').value = p.unitName || '';
                    document.getElementById('prod-bulk-name').value = p.bulkName || '';
                    document.getElementById('prod-bulk-qty').value = p.bulkQty || '';
                    document.getElementById('prod-bulk-sell').value = p.bulkSellPrice || '';
                }

                if (p.isMid) {
                    document.getElementById('mid-toggle').checked = true;
                    document.getElementById('mid-inputs-container').classList.remove('hidden');
                    document.getElementById('prod-mid-name').value = p.midName || '';
                    document.getElementById('prod-mid-qty').value = p.midQty || '';
                    document.getElementById('prod-mid-sell').value = p.midSellPrice || '';
                }
            } else { 
                document.getElementById('prod-id').value = ""; 
                document.getElementById('modal-title').innerText = "নতুন পণ্য যুক্ত করুন"; 
            }
            modal.classList.remove('hidden');
        }

        function editProduct(id) { openProductModal(id); }

        async function deleteProduct(id) { 
            if(confirm("এই পণ্যটি মুছে ফেলতে চান?")) { 
                const { error } = await _supabase.from('products').delete().eq('id', id);
                if (error) {
                    showToast("ডিলিট করতে সমস্যা হয়েছে", "error");
                } else {
                    state.products = state.products.filter(p => p.id !== id); 
                    renderInventory(); 
                    renderProducts(); 
                    showToast("পণ্য মুছে ফেলা হয়েছে", "success"); 
                }
            } 
        }

        async function handleProductSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('prod-id').value; 
            const name = document.getElementById('prod-name').value; 
            const buy = parseFloat(document.getElementById('prod-buy').value); 
            const sell = parseFloat(document.getElementById('prod-sell').value); 
            const stock = parseInt(document.getElementById('prod-stock').value); 
            const loc = document.getElementById('prod-loc').value;
            
            const isBulk = document.getElementById('bulk-toggle').checked;
            const unitName = document.getElementById('prod-unit-name').value;
            const bulkName = document.getElementById('prod-bulk-name').value;
            const bulkQty = parseFloat(document.getElementById('prod-bulk-qty').value) || 0;
            const bulkSellPrice = parseFloat(document.getElementById('prod-bulk-sell').value) || 0;

            const isMid = document.getElementById('mid-toggle').checked;
            const midName = document.getElementById('prod-mid-name').value;
            const midQty = parseFloat(document.getElementById('prod-mid-qty').value) || 0;
            const midSellPrice = parseFloat(document.getElementById('prod-mid-sell').value) || 0;

            const payload = { 
                name, buyPrice: buy, sellPrice: sell, stock, location: loc,
                isBulk, unitName, bulkName, bulkQty, bulkSellPrice,
                isMid, midName, midQty, midSellPrice 
            };
            
            try {
                if (id) { 
                    const { error } = await _supabase.from('products').update(payload).eq('id', id);
                    if(error) throw error;
                    const p = state.products.find(x => x.id == id); 
                    Object.assign(p, payload); 
                    showToast("আপডেট সফল হয়েছে", "success"); 
                } else { 
                    const { data, error } = await _supabase.from('products').insert([payload]).select();
                    if(error) throw error;
                    if(data && data.length > 0) {
                        state.products.push(data[0]);
                    }
                    showToast("পণ্য যুক্ত হয়েছে", "success"); 
                }
                closeModal('product-modal'); 
                renderInventory(); 
                renderProducts();
            } catch (err) {
                console.error(err);
                showToast("পণ্য সেভ করতে সমস্যা হয়েছে", "error");
            }
        }

        async function saveSettings(e) {
            e.preventDefault();
            state.settings.shopName = document.getElementById('setting-shop-name').value;
            state.settings.proprietor = document.getElementById('setting-proprietor').value;
            state.settings.mobile = document.getElementById('setting-mobile').value;
            
            const { error } = await _supabase
                .from('settings')
                .update({ 
                    shopName: state.settings.shopName,
                    proprietor: state.settings.proprietor,
                    mobile: state.settings.mobile
                })
                .eq('id', state.settings.id);

            if(error) {
                showToast("সেটিংস সেভ করতে সমস্যা হয়েছে", "error");
            } else {
                updateSettingsUI(); 
                showToast("সফলভাবে পরিবর্তন হয়েছে!", "success");
            }
        }

        function updateSettingsUI() {
            document.getElementById('setting-shop-name').value = state.settings.shopName;
            document.getElementById('setting-proprietor').value = state.settings.proprietor;
            document.getElementById('setting-mobile').value = state.settings.mobile;

            // FIX: Populate Worker PIN field automatically with current DB value
            const workerPinInput = document.getElementById('worker-new-pin');
            if (workerPinInput) {
                workerPinInput.value = state.settings.worker_pin || '';
            }
            
            document.getElementById('shop-name-header').innerText = state.settings.shopName;
            document.getElementById('shop-prop-header').innerText = `প্রোপাইটর: ${state.settings.proprietor}`;
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function toggleMobileCart() { 
            const panel = document.getElementById('cart-panel'); 
            const icon = document.getElementById('mobile-cart-icon'); 
            panel.classList.toggle('translate-y-full'); 
            if (panel.classList.contains('translate-y-full')) {
                icon.style.transform = 'rotate(0deg)';
            } else {
                icon.style.transform = 'rotate(180deg)';
            }
        }
        
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container'); 
            container.innerHTML = ''; 
            const div = document.createElement('div');
            const color = type === 'success' ? 'bg-emerald-600' : (type === 'error' ? 'bg-red-500' : 'bg-slate-800');
            div.className = `${color} text-white px-4 py-2 rounded-full shadow-lg text-xs md:text-sm font-medium fade-in text-center leading-relaxed`;
            div.innerText = msg; 
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // Start App
        init();
    </script>
</body>
</html>
